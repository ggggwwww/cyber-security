#!/bin/bash
#:set encoding=utf-8
#:set nowrap
#:set nolinebreak
#:set nomodeline
cat << 'EOF'
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%#######***********+++==========#@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@**@@@@@@@@%%%%%%@@@@@@@@@@@@@@@@@@@@@%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*%@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@%*@@#%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%++=*%%%%%%%%##########################@@%*@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@*@@@#:-=++==-::===+++=++++***+-+*#####%%@@@@@@@@@@@@@@@#-=*+-::+%@@*-..:%%:%@@=@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@*@@@%--=+++++*++***********+++++*@@@@@@@@@@@@@@@@@@@%==%#-:=%@@@@+-*+#%..::%@@-@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@*@@@#-+##****+*********###%@@@@@@@@@@@@@@@@@@@@@@#+##=-*@@@@@*--*@@++#%#=:.#@@-%@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@*@@@#=-+++*#%%%%%%%@@@@@@@@@@@@@%+:#@@@@@@@@@@@@#=+%@@@@#--*%%*-...+::=#@@##@@=#@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@*@@@#=+***##@@@@@@@@@@@@@@@@@@@@%+**@@@@@@@@#-+@@@@+-=%@*:.:@#=*@@@@#=:.  .*@@+*@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@+@@@*=#@@@@@@@@@@@@@@@@@==%+@@@@@@@@@@@@@**@@@#=+##=..:=:.-*@@#=..:#*-=*#%**@@#+@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@+@@@*=#@@@@@@@@@@@@@@@@@@@@@@@@@@@@#=@@@@%*=**-.-+#+-+#%#=:.:-+#@@@#..:-+*#+@@%=@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@+@@@*=#@@@@@@@@@@=-+@@@@@@@@@@@@@@@@@*+**=:-+*+:..----+*%%#*=-:..+-+=-:....=@@@-@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@+@@@*-#@@@@@@@@@@*=+@@@@@@@@@@@%*=+*+-=++-....-+*#+=-:--=+*##==++**##%###*+=@@@-@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@+@@@*-:+++%@@@@@@@@@@@@@@%*--+#+-.. .:-+***+**####*+=--::----==++**********=@@@-%@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@+@@@*--***#@@@@@@@@@@#--*#+:..=*#*++*%%=--.-=+*#%@@@@@@@%#####***++===---:::@@@-#@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@+@@@*-=%%%##**#@%=-*%+:..=+=+#@@@@@@@@@@@@@@@@%*++===*#%@@@#+++*##*+-:.....:@@@-+@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@+@@@*::=++%#==##=..-*%@@@@@@@@::*@@@@@@@@@@@@@@@@@@@@@@@%%@%#+=-+#%#=:::=+#=%@@==@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@*@@@*:-++#*-..-*#*+#@@@@@@@@@@=++@@@@@@@@@@@@@@@@@@@@@@@++=@@@@@@@@@#=-=##*-%@@+-@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@*@@@#:.:.:+***%@@@@@@@##@@@@@@@@@@@@@@@@@@@@@@@@@%#@@@@@@@@@@@@@@@@@@@@@@#=:#+**-@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@*@@@#:.=+**#%%%@@@@@@%:*#@@@@@@@@@@@@@@@@@@@@@@@#:+#@@@@@@@@@@@@@@@@%##*+=-:%@@#-@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@*@@@#::+%@@@@==@@@@@@@@@@@@@@@@@@@@%%%###**++++======+++++***###%%%%@%=%@@#:#@@#-@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@*@@@@-:-=====++***###%%%%@@@@@@@@@@@@@%%####@@@@@@@@@@@@@@@@@@@@@@@@@@*@@@@%@@@+*@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@-===+*@@@@@@%%#*+=-::...::--==+++++*++++%@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@*%@@@@@@@@%%##*++==---:::--=+:.=.#%%@@@@@#:%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*-:....=-.@@@@@@@@%-:#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@+=*-==----+-**####**++*%%#+-..:=%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%-.-=:::--=+*#######***+++====-::========++++***+-%@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@%+*****####%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*:*@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@%.*@@@@@@@@@@@@@@@@@@@@@@@@@@=%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%-=@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@#. .%@@@@@@@%#%#*%****+=+====+-=-+---+-*-=*-**+:#=-=#:++:--*@@@@@@=:%@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@=:+**:====%@@@@:.  :@@@@@@=.=+-.:--.++:-+:...+*.##.**.=#-=*:.++:.--.. .++**=+@@@@@*.%@@@@@@@@@@@@@@@
@@@@@@@@@@@@@+::+=@@@@@@@==%@@%:..=@@@@@*.*+::*#+.+#:::=.=.*#**#*######+:*-:--+-#*.-#-#@@@%=%@@@@#.#@@@@@@@@@@@@@
@@@@@@@@@@@@@#@@@@#-%@@@#*@%-*@@@-..#@@@@*.*#-.++=.==:::-.-...::::::::::-----===++**###%%%%%%%%%%#.*@@@@@@@@@@@@@
@@@@@@@@@@@@@*+*#@@@#=*####**:-@@@@-..*@@@@@@@@@@@@%%%%%+%%#######**+++=============+++****##%%%%@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@%#*++++**#%@@@@@@@#******####%%%%@@@@*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
++*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=++
++*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=++
*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%
*+.        .-@@:        .%@@@@@@*. :@@@@@@@=..=@@@@@@@@@: .#@@@@@@@@@*:.   ..+@@*..-@@@@@@@@@-..+@*.     .-#@@@@%
*@*++-. :+++%@%. :++++++*@@@@@@%.  .-@@@@@@-   -@@@@@@%.   =@@@@@@@+. .:+*+-..*@=. .:%@@@@@@:   -@= .-++=:. .*@@%
*@@@@#..=@@@@@%. =@@@@@@@@@@@@@: .-  +@@@@@- .. .%@@@*. .  =@@@@@@=..=@@@@@@@@@@=. . .#@@@#. .. -@= .%@@@@@=..=@%
*@@@@#..=@@@@@%. .-----#@@@@@@-  #@:..#@@@@- .%. .#@=. :#. =@@@@@%. -@@@@@@@@@@@=..#: .+@*. :#. -@= .%@@@@@@- .%%
*@@@@#..=@@@@@%.  .....=@@@@@+..=@@@. .@@@@- .@@: ..  =@#. =@@@@@%. -@@@@@@@@@@@=..%@= ....-@%. -@= .%@@@@@@- .%%
*@@@@#..=@@@@@%. =@@@@@@@@@@#.  .....  :@@@- .@@@=. .#@@#. =@@@@@@:..#@@@@@@@@@@=..%@@*. .+@@%. -@= .%@@@@@%..:@%
*@@@@#..=@@@@@%. -@@@@@@@@@%. ......... =@@- .@@@@@%@@@@#. =@@@@@@@:..:#@@@%--%@=..%@@@@%@@@@%. -@= .*@@@#: .-@@%
*@@@@#..=@@@@@%.        .#@- .#@@@@@@@=..*@- .@@@@@@@@@@#. =@@@@@@@@#:.     .:#@=..%@@@@@@@@@%. =@+.      .:%@@@%
*@@@@@%#@@@@@@@@%%%%%%%%@@@@*%@@@@@@@@@##@@@#%@@@@@@@@@@@%#@@@@@@@@@@@@@%##@@@@@@#%@@@@@@@@@@@%#@@@@%%%%%@@@@@@@%
*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%
++*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=++
+++%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#=++
EOF
line="===================================================================================================="
# ANSI 색상 정의
COLOR_LINE="\033[38;5;117m"   # 세련된 하늘색
COLOR_TITLE="\033[1;38;5;117m"  # 굵은 세련된 하늘색
COLOR_OK="\033[32m"          # 초록색
COLOR_WARN="\033[38;5;214m"  # 주황색
COLOR_RESET="\033[0m"        # 색상 초기화
COLOR_BG_RED="\033[41;1;37m"  # 빨간색 배경 + 굵은 흰색 글씨
COLOR_RESET="\033[0m"

#---------------------
#김관웅 함수
#주요 출력포맷
function fmt(){
	#항목 번호
	local num="$1"
	#양호기준 
	local stdGood="$2"
	#취약기준
	local stdBad="$3"
	#보안 상태
	local stats="$4"
	#결과
	local res="$5"
	#결과2
	local res2="$6"
	
	echo "[U-$num] /etc/shadow 파일 소유자 및 권한 설정" 
	echo " 기준: " 
	echo " [양호] : $stdGood"
	echo " [취약] : $stdBad"
	echo $line
	echo " 점검 결과:" 
	echo " $res "
	if [ "$stats" = "good" ]; then
		echo "[양호] : $res2 "
	elif [ "$stats" = "bad" ]; then
		echo "[취약] : $res2 "
	fi
	echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

}
#---------------------

VULN_LIST=() # 취약 항목 저장용 배열
# 점검 시작 헤더 출력
echo -e "${COLOR_TITLE}==================================================================== ${COLOR_RESET}"
echo -e "${COLOR_TITLE} 팀명: cmd${COLOR_RESET}" 
echo -e "${COLOR_TITLE} 시스템 보안 점검 결과${COLOR_RESET}"
echo -e "${COLOR_TITLE} 점검 일시: $(date '+%Y-%m-%d %H:%M:%S')${COLOR_RESET}" 
echo -e "${COLOR_TITLE} 호스트명: $(hostname)${COLOR_RESET}"
echo -e "${COLOR_TITLE} OS 정보: $(cat /etc/*release | head -n 1)${COLOR_RESET}" 
echo -e "${COLOR_TITLE}  커널 버전: $(uname -r)${COLOR_RESET}" 
echo -e "${COLOR_TITLE}==================================================================== ${COLOR_RESET}"
echo "" |

#=========================
#김관웅
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
# [U-01] 
fmt 01 "원격 터미널 서비스를 사용하지 않거나, 사용 시 root 직접 접속을 차단한 경우" "원격 터미널 서비스 사용 시 root 직접 접속을 허용한 경우"  bad "[telnet] /etc/pam.d/login -> 'auth required /lib/security/lib/security/pam_securetty.so' 구문이 설정되어 있지 않습니다, [SSH] /etc/ssh/sshd_config -> 'PermitRootLogin no' 구문이 설정되어 있지 않습니다. " "원격 접속 시 root 계정으로 바로 접속하는 설정파일이 옳바르지 않습니다."
VULN_LIST+=("[U-01] 원격 터미널 서비스 설정")

# [U-02]
fmt 02 "패스워드 최소길이 8자리 이상, 영문.숫자.특수문자 최소 입력 기능이 설정된 경우" "패스워드 최소길이 8자리 이상, 영문 숫자.특수문자 최소 입력기능이 설정된 경우" bad  "/etc/security/pwquality.conf -> 패스워드 복잡성 설정이 옳바르지 않습니다."  "ocredit(특수문자), dcredit(숫자), ucredit&lcredit(영문자) 설정 값이 '0'으로 되어 있어 구문 설정이 올바르지 않습니다." 
VULN_LIST+=("[U-02] 패스워드 복잡성 설정")

# [U-03]
fmt 03 \
"계정 잠금 임계값이 10회 이하의 값으로 설정되어 있는 경우" \
"계정 잠금 임계값이 설정되어 있지 않거나, 10회 이하의 값으로 설정되지 않은 경우" \
bad \
"[LINUX] /etc/pam.d/system-auth → 'auth required /lib/security/pam_tally.so deny=5 unlock_time=120 no_magic_root' 구문이 존재하지 않음" \
"계정 잠금 임계값 설정이 누락되어 있어, 무작위 대입 공격에 노출될 수 있습니다."
VULN_LIST+=("[U-03] 계정 잠금 임계값 설정")

# [U-04]
fmt 04 \
"쉐도우 패스워드를 사용하거나, 패스워드를 암호화하여 저장하는 경우" \
"쉐도우 패스워드를 사용하지 않고, 패스워드를 암호화하여 저장하지 않는 경우" \
good \
"/etc/passwd 파일 내 패스워드 필드가 'x'로 표시되어 있으며, /etc/shadow 파일에 암호화된 패스워드가 저장됨" \
"쉐도우 패스워드를 통해 암호가 안전하게 분리 및 암호화 저장되고 있습니다."
VULN_LIST+=("[U-04] 쉐도우 패스워드 설정")

# [U-44]
fmt 44 \
"root 계정과 동일한 UID를 갖는 계정이 존재하지 않는 경우" \
"root 계정과 동일한 UID를 갖는 계정이 존재하는 경우" \
good \
"/etc/passwd 파일 확인 결과, UID 0을 사용하는 계정은 root만 존재함" \
"root 계정 외 UID 0을 사용하는 계정이 없어 슈퍼유저 권한이 적절히 통제되고 있습니다."
VULN_LIST+=("[U-44] UID 0 중복 계정 점검")

# [U-45]
fmt 45 \
"su 명령어를 특정 그룹에 속한 사용자만 사용하도록 제한되어 있는 경우" \
"su 명령어를 모든 사용자가 사용하도록 설정되어 있는 경우" \
bad \
"su 명령어의 실행 권한이 4755이며, 특정 그룹 제한 없이 모든 사용자가 su 명령을 사용할 수 있는 상태" \
"su 명령어 사용에 제한이 없어 일반 사용자도 root 전환이 가능하므로 보안상 취약합니다."
VULN_LIST+=("[U-45] su 명령어 사용 제한 설정")

# [U-46]
fmt 46 \
"패스워드 최소 길이가 8자 이상으로 설정되어 있는 경우" \
"패스워드 최소 길이가 8자 미만으로 설정되어 있는 경우" \
bad \
"[LINUX] /etc/login.defs -> PASS_MIN_LEN 값이 8 미만으로 설정되어 있습니다." \
"패스워드 최소 길이 설정이 기준에 부합하지 않아 보안 취약점이 존재합니다."
VULN_LIST+=("[U-46] 패스워드 최소 길이")

# [U-47]
fmt 47 \
"패스워드 최대 사용기간이 90일(12주) 이하로 설정되어 있는 경우" \
"패스워드 최대 사용기간이 90일(12주) 이하로 설정되어 있지 않은 경우" \
bad \
"[LINUX] /etc/login.defs -> PASS_MAX_DAYS 값이 90 초과 또는 설정되어 있지 않습니다." \
"패스워드 최대 사용기간이 기준보다 길게 설정되어 있어 보안상 취약합니다."
VULN_LIST+=("[U-47] 패스워드 최대 사용기간")

# [U-48]
fmt 48 \
"패스워드 최소 사용기간이 1일 이상 설정되어 있는 경우" \
"패스워드 최소 사용기간이 설정되어 있지 않은 경우" \
bad \
"[LINUX] /etc/login.defs -> PASS_MIN_DAYS 값이 0이거나 설정되어 있지 않습니다." \
"패스워드 최소 사용기간이 설정되어 있지 않아 동일 패스워드 반복 설정이 가능합니다."
VULN_LIST+=("[U-48] 패스워드 최소 사용기간")

# [U-49]
fmt 49 \
"불필요한 계정이 존재하지 않는 경우" \
"불필요한 계정이 존재하는 경우" \
bad \
"/etc/passwd 및 로그(/var/log/wtmp, /var/log/authlog, /var/log/sulog) 점검 결과 사용하지 않는 계정이 존재합니다. 예: lp, uucp, nuucp 등 미사용 계정이 확인되었습니다." \
"시스템에 불필요한 계정이 존재합니다. userdel 명령을 사용하여 삭제가 필요합니다."
VULN_LIST+=("[U-49] 불필요한 계정 존재 여부")

# [U-50]
fmt 50 \
"관리자 그룹에 불필요한 계정이 등록되어 있지 않은 경우" \
"관리자 그룹에 불필요한 계정이 등록되어 있는 경우" \
good \
"/etc/group 파일 점검 결과 root 그룹에는 root 계정만 등록되어 있습니다." \
"관리자 그룹에 불필요한 계정이 포함되어 있지 않습니다."
VULN_LIST+=("[U-50] 관리자 그룹 계정 점검")

# [U-51]
fmt 51 \
"시스템 관리나 운용에 불필요한 그룹이 삭제되어 있는 경우" \
"시스템 관리나 운용에 불필요한 그룹이 존재할 경우" \
good \
"/etc/group 및 /etc/passwd 점검 결과 계정이 존재하지 않는 불필요한 그룹이 없습니다." \
"계정이 존재하지 않는 그룹이 존재하지 않아 안전합니다."
VULN_LIST+=("[U-51] 불필요한 그룹 존재 여부")

# [U-52]
fmt 52 \
"동일한 UID로 설정된 사용자 계정이 존재하지 않는 경우" \
"동일한 UID로 설정된 사용자 계정이 존재하는 경우" \
good \
"/etc/passwd 점검 결과 동일한 UID를 가진 계정이 존재하지 않습니다." \
"동일한 UID 계정이 존재하지 않아 안전합니다."
VULN_LIST+=("[U-52] 동일 UID 계정 점검")

# [U-53]
fmt 53 \
"로그인이 필요하지 않은 계정에 /bin/false 또는 /sbin/nologin 쉘이 부여되어 있는 경우" \
"로그인이 필요하지 않은 계정에 /bin/false 또는 /sbin/nologin 쉘이 부여되지 않은 경우" \
bad \
"/etc/passwd 점검 결과 daemon, bin, sys, adm, nobody 등 불필요 계정에 쉘(/bin/bash 등)이 설정되어 있습니다." \
"불필요 계정에 쉘이 설정되어 있어 로그인이 가능합니다. /bin/false 또는 /sbin/nologin 으로 수정해야 합니다."
VULN_LIST+=("[U-53] 비로그인 계정 쉘 설정")

# [U-54]
fmt 54 \
"Session Timeout이 600초(10분) 이하로 설정되어 있는 경우" \
"Session Timeout이 600초(10분) 이하로 설정되지 않은 경우" \
bad \
"/etc/profile(.profile) 또는 /etc/csh.login, /etc/csh.cshrc 점검 결과 Session Timeout 설정이 확인되지 않았습니다." \
"Session Timeout 설정이 없어 보안 위험이 존재합니다. TMOUT=600 또는 autologout=10 설정이 필요합니다."
VULN_LIST+=("[U-54] 세션 타임아웃 설정")

# [U-05]
fmt 05 \
"PATH 환경변수에 '.'이 맨 앞이나 중간에 포함되지 않은 경우" \
"PATH 환경변수에 '.'이 맨 앞이나 중간에 포함되어 있는 경우" \
good \
"root 계정의 PATH 환경변수를 확인한 결과 '.'(현재 디렉터리)이 맨 앞이나 중간에 포함되지 않았습니다." \
"PATH 환경변수가 안전하게 설정되어 있습니다."
VULN_LIST+=("[U-05] PATH 환경변수 보안 설정")

# [U-06]
fmt 06 \
"소유자가 존재하지 않는 파일 및 디렉터리가 존재하지 않는 경우" \
"소유자가 존재하지 않는 파일 및 디렉터리가 존재하는 경우" \
good \
"find 명령어 점검 결과 소유자가 존재하지 않는 파일 및 디렉터리가 발견되지 않았습니다." \
"모든 파일과 디렉터리에 소유자가 존재하여 안전합니다."
VULN_LIST+=("[U-06] 소유자 없는 파일 점검")

# [U-07]
fmt 07 \
"/etc/passwd 파일의 소유자가 root이고 권한이 644 이하인 경우" \
"/etc/passwd 파일의 소유자가 root가 아니거나 권한이 644 이하가 아닌 경우" \
bad \
"ls -l /etc/passwd 점검 결과 소유자가 root가 아니거나 권한이 644 초과로 설정되어 있습니다." \
"/etc/passwd 파일 권한이 적절하지 않습니다. chown root /etc/passwd 및 chmod 644 /etc/passwd 명령으로 조정이 필요합니다."
VULN_LIST+=("[U-07] /etc/passwd 파일 권한 점검")

#============================
#========================
#김서진
# U-8
file="/etc/shadow"
owner=$(stat -c "%U" $file 2>/dev/null)
perm=$(stat -c "%a" $file 2>/dev/null)
echo "[U-8] /etc/shadow 파일 소유자 및 권한 설정" 
echo " 기준:" 
echo " [양호] : /etc/shadow 파일의 소유자가 root이고, 권한이 400 이하인 경우"
echo " [취약] : /etc/shadow 파일의 소유자가 root가 아니거나, 권한이 400 이하가 아닌 경우" 
echo ""
echo $line 
echo " 점검 결과:" 
echo " 소유자 :  $owner , 권한 : $perm 이므로 "
if [ "$owner" = "root" ] && [ "$perm" -le 400 ]; then
    echo "[양호] : /etc/shadow 파일의 소유자 및 권한이 기준에 맞습니다." 
else
    echo "[취약] : /etc/shadow 파일의 소유자 또는 권한이 기준과 맞지 않습니다." 
    VULN_LIST+=("[U-8] /etc/shadow 파일")
fi
echo "" 
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

# U-9
file2="/etc/hosts"
owner2=$(stat -c "%U" $file2 2>/dev/null)
perm2=$(stat -c "%a" $file2 2>/dev/null)
echo "[U-9] /etc/hosts 파일의 권한 적절성 점검" 
echo " 기준:" 
echo " [양호] : /etc/hosts 파일의 소유자가 root이고, 권한이 600인 경우"
echo " [취약] : /etc/hosts 파일의 소유자가 root가 아니거나, 권한이 600 이상인 경우" 
echo "" 
echo $line
echo " 점검 결과:" 
echo " 소유자 :  $owner2 , 권한 : $perm2 이므로 "
if [ "$owner2" = "root" ] && [ "$perm2" -eq 600 ]; then
    echo "[양호] : /etc/hosts 파일의 소유자 및 권한이 기준에 맞습니다." 
else
    echo "[취약] : /etc/hosts 파일의 소유자 또는 권한이 기준과 맞지 않습니다." 
    VULN_LIST+=("[U-9] /etc/hosts 파일")
fi
echo "" 
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

# U - 10
file10="/etc/xinetd.conf"

echo "[U-10] /etc/(x)inetd.conf 파일 권한 적절성 점검" 
echo "기준:"
echo " [양호]: /etc/inetd.conf 파일의 소유자가 root이고, 권한이 600인 경우"
echo " [취약]: /etc/inetd.conf 파일의 소유자가 root가 아니거나, 권한이 600이 아닌 경우"
echo "" 
echo $line 

if [ -f "$file10" ]; then
    owner10=$(stat -c "%U" $file10)
    perm10=$(stat -c "%a" $file10)
    echo " 점검 결과:"
    echo " 소유자 : $owner10 , 권한 : $perm10 이므로 " 

    if [ "$owner10" = "root" ] && [ "$perm10" -eq 600 ]; then
        echo "[양호] : /etc/xinetd.conf 파일의 소유자 및 권한이 기준에 맞습니다." 
    else
        echo "[취약] : /etc/xinetd.conf 파일의 소유자 또는 권한이 기준과 맞지 않습니다." 
        VULN_LIST+=("[U-10] /etc/xinetd.conf 파일")
    fi
else
    echo " 점검 결과: /etc/xinetd.conf 파일이 존재하지 않습니다." 
    echo "[양호] : 해당 파일이 없어 취약 요소가 없습니다."
fi
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

# U - 11
file11="/etc/rsyslog.conf"   # 록키 리눅스 기준, 구 버전은 /etc/syslog.conf
echo "[U-11] $file11 파일 권한 적절성 점검" 
echo "기준:" 
echo " [양호] : 소유자가 root, bin, sys 중 하나이고, 권한이 640 이하인 경우" 
echo " [취약] : 소유자가 root, bin, sys가 아니거나, 권한이 640 초과인 경우" 
echo "" 
echo $line

if [ -f "$file11" ]; then
    owner11=$(stat -c "%U" $file11)
    perm11=$(stat -c "%a" $file11)
    echo " 점검 결과:" 
    echo " 소유자 : $owner11 , 권한 : $perm11" 

    # 소유자가 root, bin, sys 중 하나인지 확인
    if [[ "$owner11" =~ ^(root|bin|sys)$ ]] && [ "$perm11" -le 640 ]; then
        echo "[양호] : $file11 파일의 소유자 및 권한이 기준에 맞습니다." 
    else
        echo "[취약] : $file11 파일의 소유자 또는 권한이 기준과 맞지 않습니다." 
        VULN_LIST+=("[U-11] $file11 파일의 소유자 또는 권한이 기준과 맞지않음")
    fi
else
    echo " 점검 결과: $file11 파일이 존재하지 않습니다." 
    echo "[양호] : 해당 파일이 없어 취약 요소가 없습니다."
fi
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

# U - 12
file12="/etc/services"
echo "[U-12] $file12 파일 권한 적절성 점검"
echo "기준:"
echo " [양호] : 소유자가 root, bin, sys 중 하나이고, 권한이 644 이하인 경우"
echo " [취약] : 소유자가 root, bin, sys가 아니거나, 권한이 644 초과인 경우"
echo ""
echo $line

if [ -e "$file12" ]; then
    owner12=$(stat -c "%U" $file12)
    perm12=$(stat -c "%a" $file12)
    echo " 점검 결과:"

    echo " 소유자 : $owner12 , 권한 : $perm12"

    # 소유자가 root, bin, sys 중 하나인지 확인
    if [[ "$owner12" =~ ^(root|bin|sys)$ ]] && [ "$perm12" -le 644 ]; then
        echo "[양호] : $file12 파일의 소유자 및 권한이 기준에 맞습니다."
    else
        echo "[취약] : $file12 파일의 소유자 또는 권한이 기준과 맞지 않습니다."
        VULN_LIST+=("[U-12] $file12 파일")
    fi
else
    echo " 점검 결과: $file12 파일이 존재하지 않습니다."
    echo "[양호] : 해당 파일이 없어 취약 요소가 없습니다."
fi
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

# U -13
file13="불필요하거나 악의적인 파일에 SUID/SGID 설정 여부 점검"
echo "[U-13] $file13"
echo "기준:"
echo " [양호] : 주요 실행파일의 권한에 SUID와 SGID에 대한 설정이 부여되어 있지 않은 경우"
echo " [취약] : 주요 실행파일의 권한에 SUID와 SGID에 대한 설정이 부여되어 있는 경우"
echo ""
echo $line

# 실제 점검 로직
SUID_SGID=$(find / -user root -type f \( -perm -04000 -o -perm -02000 \) -xdev 2>/dev/null)

echo " 점검 결과:"
if [ -z "$SUID_SGID" ]; then
    echo "[양호] : 주요 실행파일에 불필요한 SUID/SGID 설정이 존재하지 않습니다."
else
    echo "[취약] : 주요 실행파일에 불필요한 SUID/SGID 설정이 발견되었습니다."
    VULN_LIST+=("[U-13] 불필요한 SUID/SGID 설정 존재")
fi
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

# U -14
file14="$HOME/.bashrc $HOME/.bash_profile $HOME/.profile"
echo "기준:"
echo " [양호] : 홈 디렉터리 환경변수 파일 소유자가 root 또는 해당 계정이고, root와 소유자만 쓰기 권한이 부여된 경우"
echo " [취약] : 홈 디렉터리 환경변수 파일 소유자가 root 또는 해당 계정이 아니거나, root와 소유자 외에 쓰기 권한이 부여된 경우"
echo ""
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

for f in $file14; do
    if [ -f "$f" ]; then
        owner=$(stat -c "%U" $f)
        perm=$(stat -c "%a" $f)
        reason=""

        # 소유자 체크
        if [[ "$owner" != "root" && "$owner" != "$USER" ]]; then
            reason+="소유자($owner)가 기준과 다름; "
        fi

        # 기타 쓰기 권한 체크 (other write)
        other_write=$((perm % 10))
        if [ $other_write -gt 0 ]; then
            reason+="기타 사용자에게 쓰기 권한 부여됨($perm); "
        fi

        # 결과 출력 및 VULN_LIST 등록
        if [ -z "$reason" ]; then
            echo " $f : [양호] 소유자($owner) 및 권한($perm) 기준 적합"
        else
            echo " $f : [취약] $reason"
            VULN_LIST+=("[U-14]  $f  파일")
        fi
    else
        echo " $f : 파일이 존재하지 않음"
	echo "[양호] : 해당 파일이 없어 취약 요소가 없습니다."    
fi
done

# U -15
file15="불필요한 world writable 파일 존재 여부 점검"
echo "[U-15] $file15 "
echo "기준:"
echo " [양호] : 시스템 중요 파일에 world writable 파일이 존재하지 않거나, 존재 시 설정 이유를 확인하고 있는 경우"
echo " [취약] : 시스템 중요 파일에 world writable 파일이 존재하나 해당 설정 이유를 확인하고 있지 않는 경우"
echo ""
echo $line

# 실제 점검 로직
WORLD_WRITABLE=$(find / -xdev -type f -perm -0002 2>/dev/null)

echo "점검 결과:"
if [ -z "$WORLD_WRITABLE" ]; then
    echo "[양호] : 불필요한 world writable 파일이 존재하지 않습니다."
else
    echo "[취약] : 불필요한 world writable 파일이 발견되었습니다."
    VULN_LIST+=("[U-15] 불필요한 world writable 파일 존재")
fi
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

# U-16
file16="불필요한 device 파일 존재 여부 점검"
echo "[U-16] $file16 "
echo "기준:"
echo " [양호] : /dev 디렉터리에 불필요한 device 파일이 존재하지 않는 경우"
echo " [취약] : /dev 디렉터리에 불필요한 device 파일이 존재하는 경우"
echo ""
echo $line

# 실제 점검 로직
UNNECESSARY_DEV=$(find /dev -type f -exec file {} \; | grep "device" 2>/dev/null)

echo "점검 결과:"
if [ -z "$UNNECESSARY_DEV" ]; then
    echo "[양호] : 불필요한 device 파일이 존재하지 않습니다."
else
    echo "[취약] : 불필요한 device 파일이 발견되었습니다."
    VULN_LIST+=("[U-16] 불필요한 device 파일 존재")
fi
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

# U-17
file17="hosts.equiv 및 .rhosts 파일 설정 점검"
echo "[U-17] $file17 "
echo "기준:"
echo " [양호] : login, shell, exec 서비스를 사용하지 않거나, 사용 시 아래 설정이 적용된 경우"
echo "          1. /etc/hosts.equiv 및 \$HOME/.rhosts 파일 소유자가 root 또는 해당 계정"
echo "          2. 파일 권한이 600 이하"
echo "          3. 파일 내 ‘+’ 설정이 없는 경우"
echo " [취약] : login, shell, exec 서비스를 사용하고, 위 설정이 적용되지 않은 경우"
echo ""
echo $line 

# 실제 점검 로직
VULN_FLAG=0

# /etc/hosts.equiv 점검
if [ -f "/etc/hosts.equiv" ]; then
    owner_hosts=$(stat -c "%U" /etc/hosts.equiv)
    perm_hosts=$(stat -c "%a" /etc/hosts.equiv)
    plus_hosts=$(grep -E '^\+' /etc/hosts.equiv)

    if [[ "$owner_hosts" != "root" ]] || [ "$perm_hosts" -gt 600 ] || [ -n "$plus_hosts" ]; then
        VULN_FLAG=1
        VULN_LIST+=("[U-17] /etc/hosts.equiv 파일 설정 취약")
    fi
fi

# 사용자 홈 디렉터리 .rhosts 점검
for user_home in /home/* /root; do
    rhosts_file="$user_home/.rhosts"
    if [ -f "$rhosts_file" ]; then
        owner_rhosts=$(stat -c "%U" "$rhosts_file")
        perm_rhosts=$(stat -c "%a" "$rhosts_file")
        plus_rhosts=$(grep -E '^\+' "$rhosts_file")

        if [[ "$owner_rhosts" != "$(basename $user_home)" && "$owner_rhosts" != "root" ]] \
           || [ "$perm_rhosts" -gt 600 ] || [ -n "$plus_rhosts" ]; then
            VULN_FLAG=1
            VULN_LIST+=("[U-17] $rhosts_file 파일 설정 취약")
        fi
    fi
done

echo "점검 결과:"
if [ $VULN_FLAG -eq 0 ]; then
    echo "[양호] : hosts.equiv 및 .rhosts 파일 설정이 모두 안전합니다."
else
    echo "[취약] : hosts.equiv 또는 .rhosts 파일 설정에 취약이 발견되었습니다."
fi
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

# U-18
file18="허용할 호스트에 대한 접속 IP 주소 제한 및 포트 제한 설정 여부 점검"
echo "[U-18] $file18 "
echo "기준:"
echo " [양호] : 접속을 허용할 특정 호스트에 대한 IP 주소 및 포트 제한이 설정된 경우"
echo " [취약] : 접속 허용 IP 및 포트 제한이 설정되지 않은 경우"
echo ""
echo $line

# 실제 점검 로직
VULN_FLAG=0

# 1) TCP Wrappers (Linux/Unix)
if [ -f "/etc/hosts.allow" ] && [ -f "/etc/hosts.deny" ]; then
    deny_count=$(grep -v '^\s*#' /etc/hosts.deny | grep -v '^$' | wc -l)
    allow_count=$(grep -v '^\s*#' /etc/hosts.allow | grep -v '^$' | wc -l)

    if [ "$deny_count" -eq 0 ] || [ "$allow_count" -eq 0 ]; then
        VULN_FLAG=1
    fi
else
    VULN_FLAG=1
fi

# 2) IPtables (Linux)
if command -v iptables >/dev/null 2>&1; then
    iptables_rules=$(iptables -L 2>/dev/null | grep -v '^Chain' | grep -v '^target')
    if [ -z "$iptables_rules" ]; then
        VULN_FLAG=1
    fi
fi

echo "점검 결과:"
if [ $VULN_FLAG -eq 0 ]; then
    echo "[양호] : 허용 호스트 IP 및 포트 제한이 설정되어 있습니다."
else
    echo "[취약] : 허용 호스트 IP 및 포트 제한이 설정되어 있지 않거나 미흡합니다."
    VULN_LIST+=("[U-18] 허용 호스트 IP/포트 제한 미설정")
fi
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

# U-19
file19="Finger 서비스 비활성화 여부 점검"
echo "[U-19] $file19 "
echo "기준:"
echo " [양호] : Finger 서비스가 비활성화 되어 있는 경우"
echo " [취약] : Finger 서비스가 활성화 되어 있는 경우"
echo ""
echo $line

# 실제 점검 로직
VULN_FLAG=0

# 1) inetd.conf 확인 (Linux 5.9 이하)
if [ -f "/etc/inetd.conf" ]; then
    finger_line=$(grep -v '^\s*#' /etc/inetd.conf | grep finger)
    if [ -n "$finger_line" ]; then
        VULN_FLAG=1
    fi
fi

# 2) xinetd.d/finger 확인 (xinetd 기반)
if [ -f "/etc/xinetd.d/finger" ]; then
    disable_value=$(grep -i "disable" /etc/xinetd.d/finger | awk -F'=' '{print $2}' | tr -d ' ')
    if [ "$disable_value" != "yes" ]; then
        VULN_FLAG=1
    fi
fi

# 3) 프로세스 확인
finger_process=$(ps -ef | grep -v grep | grep -E 'in.fingerd|fingerd')
if [ -n "$finger_process" ]; then
    VULN_FLAG=1
fi

echo "점검 결과:"
if [ $VULN_FLAG -eq 0 ]; then
    echo "[양호] : Finger 서비스가 비활성화 되어 있습니다."
else
    echo "[취약] : Finger 서비스가 활성화 되어 있습니다."
    VULN_LIST+=("[U-19] Finger 서비스 활성화")
fi
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

# U-20
file20="익명 FTP 접속 허용 여부 "
echo "[U-20] $file20 점검"
echo "기준:"
echo " [양호] : Anonymous FTP 접속이 차단된 경우"
echo " [취약] : Anonymous FTP 접속이 차단되지 않은 경우"
echo ""
echo $line

# 실제 점검 로직
VULN_FLAG=0

# 1) 일반 FTP 계정 확인 (/etc/passwd)
if grep -qE '^(ftp|anonymous):' /etc/passwd 2>/dev/null; then
    VULN_FLAG=1
fi

# 2) ProFTP 설정 확인
PROFTP_CONF=""
if [ -f "/etc/proftpd.conf" ]; then
    PROFTP_CONF="/etc/proftpd.conf"
elif [ -f "/etc/proftpd/proftpd.conf" ]; then
    PROFTP_CONF="/etc/proftpd/proftpd.conf"
fi

if [ -n "$PROFTP_CONF" ]; then
    anonymous_setting=$(grep -i "UserAlias\|Anonymous" "$PROFTP_CONF" | grep -v '^\s*#')
    if [ -n "$anonymous_setting" ]; then
        VULN_FLAG=1
    fi
fi

# 3) vsFTP 설정 확인
VSFTP_CONF=""
if [ -f "/etc/vsftpd/vsftpd.conf" ]; then
    VSFTP_CONF="/etc/vsftpd/vsftpd.conf"
elif [ -f "/etc/vsftpd.conf" ]; then
    VSFTP_CONF="/etc/vsftpd.conf"
fi

if [ -n "$VSFTP_CONF" ]; then
    anonymous_enable=$(grep -i "^anonymous_enable" "$VSFTP_CONF" | grep -v '^\s*#' | awk -F'=' '{print $2}' | tr -d ' ')
    if [ "$anonymous_enable" != "NO" ]; then
        VULN_FLAG=1
    fi
fi

echo "점검 결과:"
if [ $VULN_FLAG -eq 0 ]; then
    echo "[양호] : 익명 FTP 접속이 차단되어 있습니다."
else
    echo "[취약] : 익명 FTP 접속이 허용되어 있습니다."
    VULN_LIST+=("[U-20] 익명 FTP 접속 허용")
fi
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

# U-55
file55="/etc/hosts.lpd 파일 삭제 및 권한 적절성"
echo "[U-55] $file55 점검"
echo "기준:"
echo " [양호] : hosts.lpd 파일이 삭제되었거나, 사용 시 소유자가 root이고 권한이 600인 경우"
echo " [취약] : hosts.lpd 파일이 삭제되지 않았거나, 소유자가 root가 아니거나 권한이 600이 아닌 경우"
echo ""
echo $line

# 실제 점검 로직
VULN_FLAG=0

if [ -f "/etc/hosts.lpd" ]; then
    owner=$(stat -c "%U" /etc/hosts.lpd)
    perm=$(stat -c "%a" /etc/hosts.lpd)

    if [ "$owner" != "root" ] || [ "$perm" -ne 600 ]; then
        VULN_FLAG=1
    fi
fi

echo "점검 결과:"
if [ ! -f "/etc/hosts.lpd" ] || [ $VULN_FLAG -eq 0 ]; then
    echo "[양호] : /etc/hosts.lpd 파일이 삭제되었거나 권한이 적절합니다."
else
    echo "[취약] : /etc/hosts.lpd 파일이 존재하며 소유자 또는 권한이 적절하지 않습니다."
    VULN_LIST+=("[U-55] /etc/hosts.lpd 파일 권한/소유자 문제")
fi
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

# U-56
file56="시스템 UMASK 값 022이상인지"
echo "[U-56] $file56 점검"
echo "기준:"
echo " [양호] : UMASK 값이 022 이상으로 설정된 경우"
echo " [취약] : UMASK 값이 022 이상으로 설정되지 않은 경우"
echo ""
echo $line

# 실제 점검 로직
VULN_FLAG=0

if [ -f "/etc/profile" ]; then
    # /etc/profile에서 umask 설정 확인
    UMASK_VALUE=$(grep -E '^\s*umask' /etc/profile | tail -n 1 | awk '{print $2}')
    if [ -z "$UMASK_VALUE" ]; then
        VULN_FLAG=1
    else
        # 숫자 비교: 022 이상이면 양호
        if [ "$UMASK_VALUE" -ge 22 ]; then
            VULN_FLAG=0
        else
            VULN_FLAG=1
        fi
    fi
else
    VULN_FLAG=1
fi

echo "점검 결과:"
if [ $VULN_FLAG -eq 0 ]; then
    echo "[양호] : 시스템 UMASK 값이 022 이상으로 설정되어 있습니다."
else
    echo "[취약] : 시스템 UMASK 값이 022 이상으로 설정되어 있지 않습니다."
    VULN_LIST+=("[U-56] 시스템 UMASK 값 미설정 또는 낮음")
fi
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

# U-57
file57="홈 디렉터리 소유자 외 타 사용자가 해당 홈 디렉터리를 수정할 수 없도록 제한하는지"
echo "[U-57] $file57 점검"
echo "기준:"
echo " [양호] : 홈 디렉터리 소유자가 해당 계정이고, 타 사용자 쓰기 권한이 제거된 경우"
echo " [취약] : 홈 디렉터리 소유자가 해당 계정이 아니거나, 타 사용자 쓰기 권한이 부여된 경우"
echo ""
echo $line

# 실제 점검 로직
VULN_FLAG=0

# /etc/passwd 파일에서 사용자와 홈 디렉터리 확인
while IFS=: read -r username _ uid _ _ home _; do
    # UID 1000 이상 일반 사용자만 점검 (루트 제외)
    if [ "$uid" -ge 1000 ] && [ -d "$home" ]; then
        owner=$(stat -c "%U" "$home")
        perm=$(stat -c "%a" "$home")
        # 타 사용자 쓰기 권한(o-w) 확인
        o_write=$((perm % 10))
        if [ "$owner" != "$username" ] || [ "$o_write" -ne 0 ]; then
            VULN_FLAG=1
            VULN_LIST+=("[U-57] $home : 소유자 또는 타 사용자 쓰기 권한 문제")
        fi
    fi
done < /etc/passwd

echo "점검 결과:"
if [ $VULN_FLAG -eq 0 ]; then
    echo "[양호] : 홈 디렉터리 소유자 외 타 사용자 쓰기 권한이 적절히 제한되어 있습니다."
else
    echo "[취약] : 홈 디렉터리 소유자 외 타 사용자 쓰기 권한이 부적절합니다."
fi
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

# U-58
file58="사용자 계정과 홈 디렉터리 일치 여부 점검"
echo "[U-58] $file58 "
echo "기준:"
echo " [양호] : 홈 디렉터리가 존재하지 않는 계정이 발견되지 않은 경우"
echo " [취약] : 홈 디렉터리가 존재하지 않는 계정이 발견된 경우"
echo ""
echo $line

# 실제 점검 로직
VULN_FLAG=0

# /etc/passwd 파일에서 사용자와 홈 디렉터리 확인
while IFS=: read -r username _ uid _ _ home _; do
    # UID 1000 이상 일반 사용자만 점검 (루트 제외)
    if [ "$uid" -ge 1000 ]; then
        if [ ! -d "$home" ]; then
            VULN_FLAG=1
            VULN_LIST+=("[U-58] $username : 홈 디렉터리 없음 ($home)")
        fi
    fi
done < /etc/passwd

echo "점검 결과:"
if [ $VULN_FLAG -eq 0 ]; then
    echo "[양호] : 홈 디렉터리가 없는 사용자 계정이 없습니다."
else
    echo "[취약] : 홈 디렉터리가 없는 사용자 계정이 발견되었습니다."
fi
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

# U-59
file59="숨김 파일 및 디렉터리 내 의심스러운 파일 존재 여부 점검"
echo "[U-59] $file59 "
echo "기준:"
echo " [양호] : 불필요하거나 의심스러운 숨겨진 파일 및 디렉터리를 삭제한 경우"
echo " [취약] : 불필요하거나 의심스러운 숨겨진 파일 및 디렉터리를 방치한 경우"
echo ""
echo $line

# 실제 점검 로직
VULN_FLAG=0

# 루트 디렉터리부터 숨김 파일과 디렉터리 검색
HIDDEN_FILES=$(find / -type f -name ".*" 2>/dev/null)
HIDDEN_DIRS=$(find / -type d -name ".*" 2>/dev/null)

if [ -n "$HIDDEN_FILES" ] || [ -n "$HIDDEN_DIRS" ]; then
    VULN_FLAG=1
    VULN_LIST+=("[U-59] 숨김 파일/디렉터리 존재")
fi

echo "점검 결과:"
if [ $VULN_FLAG -eq 0 ]; then
    echo "[양호] : 의심스러운 숨김 파일 및 디렉터리가 존재하지 않습니다."
else
    echo "[취약] : 의심스러운 숨김 파일 및 디렉터리가 발견되었습니다."
fi
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"

#==========================================================================
#=========================================================================

LINE="===================================================================================================="
#배재형
# ========================= U-21 =========================
echo "[U-21] r계열 서비스 비활성화 확인" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : rsh, rlogin, rexec 서비스가 비활성화 되어 있는 경우" | tee -a $RESULT_FILE
echo " [취약] : 활성화 되어 있는 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo "$LINE" | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

for service in rsh rlogin rexec; do
    status=$(systemctl is-enabled $service 2>/dev/null)
    if [ "$status" = "enabled" ]; then
        echo "[취약] : $service" | tee -a $RESULT_FILE
        VULN_LIST+=("[U-21] $service 서비스 활성")
    else
        echo "[양호] : $service" | tee -a $RESULT_FILE
    fi
done
echo "" | tee -a $RESULT_FILE
echo -e "${COLOR_WARN} $LINE ${COLOR_RESET}"

# ========================= U-22 =========================
echo "[U-22] cron 파일 소유자 및 권한 점검" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : 소유자가 root이고, 권한이 600 이하" | tee -a $RESULT_FILE
echo " [취약] : 소유자가 root가 아니거나, 권한이 600 초과" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo "$LINE" | tee -a $RESULT_FILE

cron_files=(/etc/crontab /etc/cron.d /etc/cron.daily /etc/cron.hourly /etc/cron.monthly /etc/cron.weekly)
for file in "${cron_files[@]}"; do
    if [ -e "$file" ]; then
        owner=$(stat -c "%U" "$file" 2>/dev/null)
        perm=$(stat -c "%a" "$file" 2>/dev/null)
        if [ "$owner" != "root" ] || [ "$perm" -gt 600 ]; then
            echo "[취약] : $file (소유자:$owner, 권한:$perm)" | tee -a $RESULT_FILE
            VULN_LIST+=("[U-22] $file 소유자/권한")
        else
            echo "[양호] : $file (소유자:$owner, 권한:$perm)" | tee -a $RESULT_FILE
        fi
    else
        echo "[양호] : $file 없음" | tee -a $RESULT_FILE
    fi
done
echo "" | tee -a $RESULT_FILE
echo -e "${COLOR_WARN} $LINE ${COLOR_RESET}"

# ========================= U-23 =========================
echo "[U-23] DoS 공격에 취약한 서비스 비활성화 점검" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : echo, discard, daytime, chargen 서비스가 비활성화 되어 있는 경우" | tee -a $RESULT_FILE
echo " [취약] : 위 서비스 중 하나라도 활성화 되어 있는 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo "$LINE" | tee -a $RESULT_FILE

dos_services=(echo discard daytime chargen)
for service in "${dos_services[@]}"; do
    status=$(systemctl is-enabled $service 2>/dev/null)
    if [ "$status" = "enabled" ]; then
        echo "[취약] : $service" | tee -a $RESULT_FILE
        VULN_LIST+=("[U-23] $service 서비스 활성")
    else
        echo "[양호] : $service" | tee -a $RESULT_FILE
    fi
done
echo "" | tee -a $RESULT_FILE
echo -e "${COLOR_WARN} $LINE ${COLOR_RESET}"

# ========================= U-24 =========================
echo "[U-24] 불필요한 서비스 비활성화 점검" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : telnet, ftp 서비스가 비활성화 되어 있는 경우" | tee -a $RESULT_FILE
echo " [취약] : 서비스가 활성화 되어 있는 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo "$LINE" | tee -a $RESULT_FILE

unneeded_services=(telnet ftp)
for service in "${unneeded_services[@]}"; do
    status=$(systemctl is-enabled $service 2>/dev/null)
    if [ "$status" = "enabled" ]; then
        echo "[취약] : $service" | tee -a $RESULT_FILE
        VULN_LIST+=("[U-24] $service 서비스 활성")
    else
        echo "[양호] : $service" | tee -a $RESULT_FILE
    fi
done
echo "" | tee -a $RESULT_FILE
echo -e "${COLOR_WARN} $LINE ${COLOR_RESET}"

# ========================= U-25 =========================
echo "[U-25] RPC 서비스 비활성화 점검" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : rpcbind 등 RPC 서비스가 비활성화 되어 있는 경우" | tee -a $RESULT_FILE
echo " [취약] : RPC 서비스가 활성화 되어 있는 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo "$LINE" | tee -a $RESULT_FILE

rpc_services=("rpcbind" "rpc.idmapd" "rpc.statd")
for svc in "${rpc_services[@]}"; do
    status=$(systemctl is-enabled $svc 2>/dev/null)
    if [ "$status" = "enabled" ]; then
        echo "[취약] : $svc" | tee -a $RESULT_FILE
        VULN_LIST+=("[U-25] $svc 서비스 활성")
    else
        echo "[양호] : $svc" | tee -a $RESULT_FILE
    fi
done
echo "" | tee -a $RESULT_FILE
echo -e "${COLOR_WARN} $LINE ${COLOR_RESET}"

# ========================= U-26 =========================
echo "[U-26] NIS/NIS+ 서비스 비활성화 점검" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : ypserv, ypbind 등 NIS/NIS+ 서비스가 비활성화 되어 있는 경우" | tee -a $RESULT_FILE
echo " [취약] : NIS/NIS+ 서비스가 활성화 되어 있는 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo "$LINE" | tee -a $RESULT_FILE

nis_services=("ypserv" "ypbind")
for svc in "${nis_services[@]}"; do
    status=$(systemctl is-enabled $svc 2>/dev/null)
    if [ "$status" = "enabled" ]; then
        echo "[취약] : $svc" | tee -a $RESULT_FILE
        VULN_LIST+=("[U-26] $svc 서비스 활성")
    else
        echo "[양호] : $svc" | tee -a $RESULT_FILE
    fi
done
echo "" | tee -a $RESULT_FILE
echo -e "${COLOR_WARN} $LINE ${COLOR_RESET}"

# ========================= U-27 =========================
echo "[U-27] TFTP, Talk 서비스 비활성화 점검" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : tftp, talk 서비스가 비활성화 되어 있는 경우" | tee -a $RESULT_FILE
echo " [취약] : 서비스가 활성화 되어 있는 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo "$LINE" | tee -a $RESULT_FILE

services=("tftp" "talk")
for svc in "${services[@]}"; do
    status=$(systemctl is-enabled $svc 2>/dev/null)
    if [ "$status" = "enabled" ]; then
        echo "[취약] : $svc" | tee -a $RESULT_FILE
        VULN_LIST+=("[U-27] $svc 서비스 활성")
    else
        echo "[양호] : $svc" | tee -a $RESULT_FILE
    fi
done
echo "" | tee -a $RESULT_FILE
echo -e "${COLOR_WARN} $LINE ${COLOR_RESET}"

# ========================= U-28 =========================
echo "[U-28] Sendmail 버전 점검" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : Sendmail이 설치되어 있지 않거나, 최신 보안 패치가 적용된 경우" | tee -a $RESULT_FILE
echo " [취약] : Sendmail이 설치되어 있고, 구버전일 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo "$LINE" | tee -a $RESULT_FILE

if command -v sendmail >/dev/null 2>&1; then
    version=$(sendmail -d0.1 -bv root 2>&1 | head -n 1)
    echo " 설치된 Sendmail 버전: $version" | tee -a $RESULT_FILE
    if echo "$version" | grep -q "8.15"; then
        echo "[양호] : Sendmail" | tee -a $RESULT_FILE
    else
        echo "[취약] : Sendmail" | tee -a $RESULT_FILE
        VULN_LIST+=("[U-28] Sendmail 구버전")
    fi
else
    echo "[양호] : Sendmail" | tee -a $RESULT_FILE
fi
echo "" | tee -a $RESULT_FILE
echo -e "${COLOR_WARN} $LINE ${COLOR_RESET}"

# ========================= U-29 =========================
echo "[U-29] 스팸메일 릴레이 제한 점검" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : 외부 릴레이가 제한된 경우" | tee -a $RESULT_FILE
echo " [취약] : 외부 릴레이가 허용되는 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo "$LINE" | tee -a $RESULT_FILE

if [ -f /etc/postfix/main.cf ]; then
    relay_policy=$(grep -i "smtpd_recipient_restrictions" /etc/postfix/main.cf)
    if echo "$relay_policy" | grep -q "permit_mynetworks"; then
        echo "[양호] : 스팸메일 릴레이" | tee -a $RESULT_FILE
    else
        echo "[취약] : 스팸메일 릴레이" | tee -a $RESULT_FILE
        VULN_LIST+=("[U-29] 외부 릴레이 가능")
    fi
else
    echo "[양호] : 스팸메일 릴레이" | tee -a $RESULT_FILE
fi
echo "" | tee -a $RESULT_FILE
echo -e "${COLOR_WARN} $LINE ${COLOR_RESET}"

# ========================= U-30 =========================
echo "[U-30] 일반 사용자의 Sendmail 실행 방지 점검" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : sendmail이 설치되어 있지 않거나 일반 사용자가 실행 불가" | tee -a $RESULT_FILE
echo " [취약] : 일반 사용자가 sendmail 실행 가능" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo "$LINE" | tee -a $RESULT_FILE

if command -v sendmail >/dev/null 2>&1; then
    sendmail_path=$(command -v sendmail)
    perm=$(stat -c "%a" "$sendmail_path")
    if [ $((perm % 10)) -eq 0 ]; then
        echo "[양호] : Sendmail" | tee -a $RESULT_FILE
    else
        echo "[취약] : Sendmail" | tee -a $RESULT_FILE
        VULN_LIST+=("[U-30] 일반 사용자 Sendmail 실행 가능")
    fi
else
    echo "[양호] : Sendmail" | tee -a $RESULT_FILE
fi
echo "" | tee -a $RESULT_FILE
echo -e "${COLOR_WARN} $LINE ${COLOR_RESET}"

# ========================= U-31 =========================
echo "[U-31] DNS 보안 버전 패치 점검" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : DNS 서버 최신 보안 패치 적용" | tee -a $RESULT_FILE
echo " [취약] : 구버전 DNS 서버" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo "$LINE" | tee -a $RESULT_FILE

if command -v named >/dev/null 2>&1; then
    version=$(named -v 2>&1 | head -n 1)
    if echo "$version" | grep -q "9.16"; then
        echo "[양호] : DNS 서버" | tee -a $RESULT_FILE
    else
        echo "[취약] : DNS 서버" | tee -a $RESULT_FILE
        VULN_LIST+=("[U-31] DNS 구버전")
    fi
else
    echo "[양호] : DNS 서버" | tee -a $RESULT_FILE
fi
echo "" | tee -a $RESULT_FILE
echo -e "${COLOR_WARN} $LINE ${COLOR_RESET}"

# ========================= U-32 =========================
echo "[U-32] DNS Zone Transfer 설정 점검" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : Zone Transfer 외부 접근 제한" | tee -a $RESULT_FILE
echo " [취약] : Zone Transfer 외부 접근 가능" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo "$LINE" | tee -a $RESULT_FILE

if command -v named >/dev/null 2>&1; then
    test_transfer=$(dig @localhost example.com AXFR 2>/dev/null | grep "Transfer failed\|connection refused")
    if [ -n "$test_transfer" ]; then
        echo "[양호] : DNS Zone Transfer" | tee -a $RESULT_FILE
    else
        echo "[취약] : DNS Zone Transfer" | tee -a $RESULT_FILE
        VULN_LIST+=("[U-32] Zone Transfer 외부 접근 가능")
    fi
else
    echo "[양호] : DNS Zone Transfer" | tee -a $RESULT_FILE
fi
echo "" | tee -a $RESULT_FILE
echo -e "${COLOR_WARN} $LINE ${COLOR_RESET}"

# ========================= U-33 =========================
echo "[U-33] 웹 서비스 디렉토리 리스팅 제거 점검" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : 디렉토리 리스팅 기능 비활성화" | tee -a $RESULT_FILE
echo " [취약] : 디렉토리 리스팅 기능 활성화" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo "$LINE" | tee -a $RESULT_FILE

WEBROOTS=("/var/www/html" "/usr/share/nginx/html")
FOUND_FILES=()

for root in "${WEBROOTS[@]}"; do
    if [ -d "$root" ]; then
        files=$(find "$root" -maxdepth 1 -type f \( -iname "test*" -o -iname "sample*" -o -iname "backup*" -o -iname "*.bak" \) 2>/dev/null)
        if [ -n "$files" ]; then
            FOUND_FILES+=($files)
        fi
    fi
done

if [ ${#FOUND_FILES[@]} -eq 0 ]; then
    echo "[양호] : 웹 루트 불필요 파일 없음" | tee -a $RESULT_FILE
else
    echo "[취약] : 웹 루트 불필요 파일 존재" | tee -a $RESULT_FILE
    for f in "${FOUND_FILES[@]}"; do
        VULN_LIST+=("[U-33] $f 존재")
    done
fi
echo "" | tee -a $RESULT_FILE
echo -e "${COLOR_WARN} $LINE ${COLOR_RESET}"

# ========================= U-34 =========================
echo "[U-34] 웹 서비스 웹 프로세스 권한 제한 점검" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : 웹 데몬이 일반 계정으로 구동" | tee -a $RESULT_FILE
echo " [취약] : 웹 데몬이 root 권한으로 구동" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo "$LINE" | tee -a $RESULT_FILE

if pgrep httpd >/dev/null 2>&1; then
    if ps -eo user,comm | grep httpd | grep -w root >/dev/null 2>&1; then
        echo "[취약] : Apache(httpd)" | tee -a $RESULT_FILE
        VULN_LIST+=("[U-34] Apache root 권한")
    else
        echo "[양호] : Apache(httpd)" | tee -a $RESULT_FILE
    fi
fi
echo -e "${COLOR_WARN} $LINE ${COLOR_RESET}"

# ========================= U-35 =========================
echo "[U-35] 웹서비스 상위 디렉토리 접근 금지 점검" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : 상위 디렉토리 접근 제한" | tee -a $RESULT_FILE
echo " [취약] : 상위 디렉토리 접근 가능" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo "$LINE" | tee -a $RESULT_FILE

# Apache 설정 점검
apache_dirs=("/etc/apache2/sites-available" "/etc/apache2/sites-enabled" "/etc/httpd/conf.d" "/etc/httpd/sites-enabled")
for d in "${apache_dirs[@]}"; do
    [ -d "$d" ] || continue
    if grep -R --line-number '\.\.' "$d"/* 2>/dev/null | grep -q '.'; then
        echo "[취약] : Apache 상위 디렉토리" | tee -a $RESULT_FILE
        VULN_LIST+=("[U-35] Apache '..' 패턴 발견")
    fi
done

# Nginx 설정 점검
if [ -d "/etc/nginx" ]; then
    if grep -R --line-number '\.\.' /etc/nginx/* 2>/dev/null | grep -q '.'; then
        echo "[취약] : Nginx 상위 디렉토리" | tee -a $RESULT_FILE
        VULN_LIST+=("[U-35] Nginx '..' 패턴 발견")
    fi
else
    echo "[양호] : Nginx" | tee -a $RESULT_FILE
fi

if ! command -v apache2 >/dev/null 2>&1 && ! command -v httpd >/dev/null 2>&1 && ! command -v nginx >/dev/null 2>&1; then
    echo "[양호] : 웹 서버 미설치" | tee -a $RESULT_FILE
fi
echo "" | tee -a $RESULT_FILE
echo -e "${COLOR_WARN} $LINE ${COLOR_RESET}"

# ========================= U-36 =========================
echo "[U-36] 웹서비스 불필요한 파일 제거 점검" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : 웹 루트에 불필요 파일 없음" | tee -a $RESULT_FILE
echo " [취약] : 웹 루트에 불필요 파일 존재" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo "$LINE" | tee -a $RESULT_FILE

WEBROOTS=("/var/www/html" "/usr/share/nginx/html")
FOUND_FILES=()
for root in "${WEBROOTS[@]}"; do
    if [ -d "$root" ]; then
        files=$(find "$root" -maxdepth 1 -type f \( -iname "test*" -o -iname "sample*" -o -iname "backup*" -o -iname "*.bak" \) 2>/dev/null)
        if [ -n "$files" ]; then
            FOUND_FILES+=($files)
        fi
    fi
done

if [ ${#FOUND_FILES[@]} -eq 0 ]; then
    echo "[양호] : 웹 루트 불필요 파일" | tee -a $RESULT_FILE
else
    echo "[취약] : 웹 루트 불필요 파일" | tee -a $RESULT_FILE
    for f in "${FOUND_FILES[@]}"; do
        VULN_LIST+=("[U-36] $f 존재")
    done
fi
echo "" | tee -a $RESULT_FILE
echo -e "${COLOR_WARN} $LINE ${COLOR_RESET}"

# ========================= U-37 =========================
echo "[U-37] 웹 서비스 웹 프로세스 권한 제한 점검" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : 웹 데몬이 일반 계정으로 구동" | tee -a $RESULT_FILE
echo " [취약] : 웹 데몬이 root 권한으로 구동" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo "$LINE" | tee -a $RESULT_FILE

if pgrep httpd >/dev/null 2>&1; then
    if ps -eo user,comm | grep httpd | grep -w root >/dev/null 2>&1; then
        echo "[취약] : Apache(httpd)" | tee -a $RESULT_FILE
        VULN_LIST+=("[U-37] Apache root 권한")
    else
        echo "[양호] : Apache(httpd)" | tee -a $RESULT_FILE
    fi
fi

if pgrep nginx >/dev/null 2>&1; then
    if ps -eo user,comm | grep nginx | grep -w root >/dev/null 2>&1; then
        echo "[취약] : Nginx" | tee -a $RESULT_FILE
        VULN_LIST+=("[U-37] Nginx root 권한")
    else
        echo "[양호] : Nginx" | tee -a $RESULT_FILE
    fi
fi

if ! pgrep httpd >/dev/null 2>&1 && ! pgrep nginx >/dev/null 2>&1; then
    echo "[양호] : 웹 서비스 미설치" | tee -a $RESULT_FILE
fi
echo "" | tee -a $RESULT_FILE
echo -e "${COLOR_WARN} $LINE ${COLOR_RESET}"

# ========================= U-38 =========================
echo "[U-38] 웹서비스 상위 디렉토리 접근 금지 점검" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : DocumentRoot 상위 디렉토리 접근 제한" | tee -a $RESULT_FILE
echo " [취약] : 상위 디렉토리 접근 가능" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo "$LINE" | tee -a $RESULT_FILE

apache_dirs=("/etc/apache2/sites-available" "/etc/apache2/sites-enabled" "/etc/httpd/conf.d" "/etc/httpd/sites-enabled")
for d in "${apache_dirs[@]}"; do
    [ -d "$d" ] || continue
    if grep -R --line-number '\.\.' "$d"/* 2>/dev/null | grep -q '.'; then
        echo "[취약] : Apache 상위 디렉토리" | tee -a $RESULT_FILE
        VULN_LIST+=("[U-38] Apache '..' 패턴 발견")
    fi
done

if [ -d "/etc/nginx" ]; then
    if grep -R --line-number '\.\.' /etc/nginx/* 2>/dev/null | grep -q '.'; then
        echo "[취약] : Nginx 상위 디렉토리" | tee -a $RESULT_FILE
        VULN_LIST+=("[U-38] Nginx '..' 패턴 발견")
    else
        echo "[양호] : Nginx" | tee -a $RESULT_FILE
    fi
else
    echo "[양호] : Nginx" | tee -a $RESULT_FILE
fi

if ! command -v apache2 >/dev/null 2>&1 && ! command -v httpd >/dev/null 2>&1 && ! command -v nginx >/dev/null 2>&1; then
    echo "[양호] : 웹 서버 미설치" | tee -a $RESULT_FILE
fi
echo "" | tee -a $RESULT_FILE
echo -e "${COLOR_WARN} $LINE ${COLOR_RESET}"



#==========================================================================
#======================================================================
#이재민
# --------------------------------------------------------------------------------------------------
# U-39 웹 서비스 링크 사용 금지
# --------------------------------------------------------------------------------------------------
APACHE_CONF="/etc/httpd/conf/httpd.conf"
VHOST_CONF="/etc/httpd/conf.d/*.conf"
LINK_VULN="양호"

echo "[U-39] 웹 서비스 링크 사용 금지" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : 심볼릭 링크, aliases 사용을 제한한 경우" | tee -a $RESULT_FILE
echo " [취약] : 심볼릭 링크, aliases 사용을 제한하지 않은 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo $line | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

if [ -f "$APACHE_CONF" ]; then
    if grep -q "Options FollowSymLinks" $APACHE_CONF && ! grep -q "Options -FollowSymLinks" $APACHE_CONF; then
        echo "   [!] 취약: $APACHE_CONF 파일에 'Options FollowSymLinks'가 활성화되어 있습니다." | tee -a $RESULT_FILE
        LINK_VULN="취약"
    else
        echo "   [V] 양호: $APACHE_CONF 파일에 'Options FollowSymLinks' 설정이 올바르게 비활성화되어 있습니다." | tee -a $RESULT_FILE
    fi
else
    echo "   [i] 정보: Apache 설정 파일($APACHE_CONF)을 찾을 수 없습니다." | tee -a $RESULT_FILE
fi

if ls $VHOST_CONF 1> /dev/null 2>&1; then
    for file in $VHOST_CONF; do
        if grep -q "Options FollowSymLinks" "$file" && ! grep -q "Options -FollowSymLinks" "$file"; then
            echo "   [!] 취약: 가상 호스트 파일($file)에 'Options FollowSymLinks'가 활성화되어 있습니다." | tee -a $RESULT_FILE
            LINK_VULN="취약"
        else
            echo "   [V] 양호: 가상 호스트 파일($file)에 'Options FollowSymLinks' 설정이 올바르게 비활성화되어 있습니다." | tee -a $RESULT_FILE
        fi
    done
fi
echo " 점검 결과: $LINK_VULN" | tee -a $RESULT_FILE
if [ "$LINK_VULN" = "취약" ]; then
    VULN_LIST+=("[U-39] 웹 서비스 링크 사용 금지")
fi

echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
# --------------------------------------------------------------------------------------------------
# U-40 웹 서비스 파일 업로드 및 다운로드 제한
# --------------------------------------------------------------------------------------------------
APACHE_CONF="/etc/httpd/conf/httpd.conf"
MIN_SIZE=5000000 # 5MB

echo "[U-40] 웹 서비스 파일 업로드 및 다운로드 제한" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : 파일 업로드 및 다운로드를 제한한 경우" | tee -a $RESULT_FILE
echo " [취약] : 파일 업로드 및 다운로드를 제한하지 않은 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo $line | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

LIMIT_VULN="양호"
LIMIT_SETTING=$(grep "^\s*LimitRequestBody" $APACHE_CONF 2>/dev/null | grep -v '#')

if [ -z "$LIMIT_SETTING" ]; then
    echo "   [!] 취약: Apache 설정 파일에 LimitRequestBody 지시어가 설정되어 있지 않습니다." | tee -a $RESULT_FILE
    LIMIT_VULN="취약"
else
    SIZE=$(echo "$LIMIT_SETTING" | awk '{print $2}')
    if [[ "$SIZE" -lt "$MIN_SIZE" ]]; then
        echo "   [V] 양호: LimitRequestBody가 $SIZE(바이트)로 설정되었습니다. (권장값: $MIN_SIZE 바이트 이상)" | tee -a $RESULT_FILE
    else
        echo "   [!] 취약: LimitRequestBody가 $SIZE(바이트)로 설정되었습니다. (권장값보다 크거나 너무 큰 값)" | tee -a $RESULT_FILE
        LIMIT_VULN="취약"
    fi
fi
echo " 점검 결과: $LIMIT_VULN" | tee -a $RESULT_FILE
if [ "$LIMIT_VULN" = "취약" ]; then
    VULN_LIST+=("[U-40] 웹 서비스 파일 업로드 및 다운로드 제한")
fi

echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
# --------------------------------------------------------------------------------------------------
# U-41 웹 서비스 영역의 분리
# --------------------------------------------------------------------------------------------------
APACHE_CONF="/etc/httpd/conf/httpd.conf"
DEFAULT_DOC_ROOTS=("/usr/local/apache/htdocs" "/usr/local/apache2/htdocs" "/var/www/html")

echo "[U-41] 웹 서비스 영역의 분리" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : DocumentRoot를 별도의 디렉터리로 지정한 경우" | tee -a $RESULT_FILE
echo " [취약] : DocumentRoot를 기본 디렉터리로 지정한 경우" | tee -a $RESULT_FILE 
echo "" | tee -a $RESULT_FILE
echo $line | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

DOC_ROOT_FOUND=$(grep "^\s*DocumentRoot" $APACHE_CONF 2>/dev/null | grep -v '#' | awk '{print $2}' | sed 's/"//g')
DOC_ROOT_VULN="양호"

if [ -z "$DOC_ROOT_FOUND" ]; then
    echo "   [!] 취약: DocumentRoot 지시어를 찾을 수 없습니다. 기본 경로가 사용될 수 있습니다." | tee -a $RESULT_FILE
    DOC_ROOT_VULN="취약"
else
    IS_DEFAULT=0
    for default_path in "${DEFAULT_DOC_ROOTS[@]}"; do
        if [ "$DOC_ROOT_FOUND" = "$default_path" ]; then
            IS_DEFAULT=1
            break
        fi
    done
    if [ $IS_DEFAULT -eq 1 ]; then
        echo "   [!] 취약: DocumentRoot가 기본 경로인 '$DOC_ROOT_FOUND'로 설정되어 있습니다." | tee -a $RESULT_FILE
        DOC_ROOT_VULN="취약"
    else
        echo "   [V] 양호: DocumentRoot가 '$DOC_ROOT_FOUND'로 설정되어 있습니다. 기본 경로가 아닙니다." | tee -a $RESULT_FILE
    fi
fi
echo " 점검 결과: $DOC_ROOT_VULN" | tee -a $RESULT_FILE
if [ "$DOC_ROOT_VULN" = "취약" ]; then
    VULN_LIST+=("[U-41] 웹 서비스 영역의 분리")
fi

echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
# --------------------------------------------------------------------------------------------------
# U-42 최신 보안패치 및 벤더 권고사항 적용
# --------------------------------------------------------------------------------------------------
echo "[U-42] 최신 보안패치 및 벤더 권고사항 적용" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : 패치 적용 정책을 수립하여 주기적으로 패치관리를 하고 있으며, 패치 관련 내용을 확인하고 적용했을 경우" | tee -a $RESULT_FILE
echo " [취약] : 패치 적용 정책을 수립하지 않고 주기적으로 패치관리를 하지 않거나 패치 관련 내용을 확인하지 않고 적용하지 않았을 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo $line | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

U42_VULN="양호"
if command -v yum &> /dev/null || command -v dnf &> /dev/null; then
    YUM_CACHE="/var/cache/yum"
    DNF_CACHE="/var/cache/dnf"
    LAST_UPDATE_TIME=""

    if [ -d "$YUM_CACHE" ]; then
        LAST_UPDATE_TIME=$(find "$YUM_CACHE" -type d -print0 | xargs -0 stat --format '%Y' | sort -n | tail -1)
    elif [ -d "$DNF_CACHE" ]; then
        LAST_UPDATE_TIME=$(find "$DNF_CACHE" -type d -print0 | xargs -0 stat --format '%Y' | sort -n | tail -1)
    fi

    if [ -n "$LAST_UPDATE_TIME" ]; then
        CURRENT_TIME=$(date +%s)
        if (( CURRENT_TIME - LAST_UPDATE_TIME > 2592000 )); then # 30일(2592000초) 이상
            echo "   [!] 취약: 패키지 캐시가 30일 이상 업데이트되지 않았습니다." | tee -a $RESULT_FILE
            U42_VULN="취약"
        else
            echo "   [V] 양호: 패키지 캐시가 최근 30일 이내에 업데이트되었습니다." | tee -a $RESULT_FILE
        fi
    else
        echo "   [i] 정보: 패키지 관리자 캐시 디렉터리를 찾을 수 없습니다. 수동 점검이 필요합니다." | tee -a $RESULT_FILE
    fi
else
    echo "   [i] 정보: yum/dnf 패키지 관리자를 찾을 수 없습니다. 수동 점검이 필요합니다." | tee -a $RESULT_FILE
fi
echo " 점검 결과: $U42_VULN" | tee -a $RESULT_FILE
if [ "$U42_VULN" = "취약" ]; then
    VULN_LIST+=("[U-42] 최신 보안패치 및 벤더 권고사항 적용")
fi

echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
# --------------------------------------------------------------------------------------------------
# U-43 로그의 정기적 검토 및 보고
# --------------------------------------------------------------------------------------------------
echo "[U-43] 로그의 정기적 검토 및 보고" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : 접속기록 등의 보안 로그, 응용 프로그램 및 시스템 로그 기록에 대해 정기적으로 검토, 분석, 리포트 작성 및 보고 등의 조치가 이루어지는 경우" | tee -a $RESULT_FILE
echo " [취약] : 위 로그 기록에 대해 정기적으로 검토, 분석, 리포트 작성 및 보고 등의 조치가 이루어 지지 않는 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo $line | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

U43_VULN="취약"
LOG_DIR="/var/log"
BACKUP_LOGS=$(find "$LOG_DIR" -type f \( -name "*.gz" -o -name "*.zip" \) -mtime -30 2>/dev/null)

if [ -n "$BACKUP_LOGS" ]; then
    echo "   [V] 양호: 최근 30일 이내에 압축된 로그 파일이 발견되었습니다." | tee -a $RESULT_FILE
    U43_VULN="양호"
else
    echo "   [!] 취약: 최근 30일 이내에 압축된 로그 파일이 발견되지 않았습니다. 수동 점검이 필요합니다." | tee -a $RESULT_FILE
fi
echo " 점검 결과: $U43_VULN" | tee -a $RESULT_FILE
if [ "$U43_VULN" = "취약" ]; then
    VULN_LIST+=("[U-43] 로그의 정기적 검토 및 보고")
fi

echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
# --------------------------------------------------------------------------------------------------
# U-60 SSH 원격접속 허용
# --------------------------------------------------------------------------------------------------
echo "[U-60] SSH 원격접속 허용" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : 원격 접속 시 SSH 프로토콜을 사용하는 경우" | tee -a $RESULT_FILE
echo " [취약] : 원격 접속 시 Telnet, FTP 등 안전하지 않은 프로토콜을 사용하는 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo $line | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

U60_VULN="양호"
UNSAFE_SERVICES=("telnet" "rsh" "rlogin" "talk")

for service in "${UNSAFE_SERVICES[@]}"; do
    if systemctl is-enabled --quiet $service 2>/dev/null || systemctl is-active --quiet $service 2>/dev/null; then
        echo "   [!] 취약: $service 서비스가 활성화되어 있습니다." | tee -a $RESULT_FILE
        U60_VULN="취약"
    else
        echo "   [V] 양호: $service 서비스가 비활성화되어 있습니다." | tee -a $RESULT_FILE
    fi
done

if ! (systemctl is-enabled --quiet sshd 2>/dev/null && systemctl is-active --quiet sshd 2>/dev/null); then
    echo "   [!] 취약: sshd 서비스가 비활성화되어 있습니다." | tee -a $RESULT_FILE
    U60_VULN="취약"
else
    echo "   [V] 양호: sshd 서비스가 올바르게 활성화되어 있습니다." | tee -a $RESULT_FILE
fi
echo " 점검 결과: $U60_VULN" | tee -a $RESULT_FILE
if [ "$U60_VULN" = "취약" ]; then
    VULN_LIST+=("[U-60] SSH 원격접속 허용")
fi

echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
# --------------------------------------------------------------------------------------------------
# U-61 FTP 서비스 확인
# --------------------------------------------------------------------------------------------------
echo "[U-61] FTP 서비스 확인" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : FTP 서비스가 비활성화 되어 있는 경우" | tee -a $RESULT_FILE
echo " [취약] : FTP 서비스가 활성화 되어 있는 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo $line | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

U61_VULN="양호"
FTP_SERVICES=("vsftpd" "proftpd" "pure-ftpd")

for service in "${FTP_SERVICES[@]}"; do
    if systemctl is-enabled --quiet $service 2>/dev/null || systemctl is-active --quiet $service 2>/dev/null; then
        echo "   [!] 취약: $service 서비스가 활성화되어 있습니다." | tee -a $RESULT_FILE
        U61_VULN="취약"
    else
        echo "   [V] 양호: $service 서비스가 비활성화되어 있습니다." | tee -a $RESULT_FILE
    fi
done
echo " 점검 결과: $U61_VULN" | tee -a $RESULT_FILE
if [ "$U61_VULN" = "취약" ]; then
    VULN_LIST+=("[U-61] FTP 서비스 확인")
fi
echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
# --------------------------------------------------------------------------------------------------
# U-62 FTP 계정 셸 제한
# --------------------------------------------------------------------------------------------------
echo "[U-62] FTP 계정 셸 제한" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : ftp 계정에 /bin/false 쉘이 부여되어 있는 경우" | tee -a $RESULT_FILE
echo " [취약] : ftp 계정에 /bin/false 쉘이 부여되어 있지 않은 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo $line | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

U62_VULN="양호"
FTP_ACCOUNT_CHECK=$(grep -E "^(ftp|anonymous)" /etc/passwd | grep -v "/bin/false")

if [ -n "$FTP_ACCOUNT_CHECK" ]; then
    echo "   [!] 취약: 다음 FTP 계정의 로그인 셸이 '/bin/false'로 설정되어 있지 않습니다." | tee -a $RESULT_FILE
    echo "$FTP_ACCOUNT_CHECK" | while IFS= read -r line; do
        echo "     - $line" | tee -a $RESULT_FILE
    done
    U62_VULN="취약"
else
    echo "   [V] 양호: FTP 관련 계정의 로그인 셸이 올바르게 설정되어 있습니다." | tee -a $RESULT_FILE
fi
echo " 점검 결과: $U62_VULN" | tee -a $RESULT_FILE
if [ "$U62_VULN" = "취약" ]; then
    VULN_LIST+=("[U-62] FTP 계정 셸 제한")
fi

echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
# --------------------------------------------------------------------------------------------------
# U-63 Ftpusers 파일 소유자 및 권한 설정
# --------------------------------------------------------------------------------------------------
echo "[U-63] Ftpusers 파일 소유자 및 권한 설정" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : ftpusers 파일의 소유자가 root이고, 권한이 640 이하인 경우" | tee -a $RESULT_FILE
echo " [취약] : ftpusers 파일의 소유자가 root가 아니거나, 권한이 640 이하가 아닌 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo $line | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

U63_VULN="양호"
FTPUSERS_FILE="/etc/ftpusers"

if [ -f "$FTPUSERS_FILE" ]; then
    OWNER=$(stat -c '%U' "$FTPUSERS_FILE")
    PERMS=$(stat -c '%a' "$FTPUSERS_FILE")

    if [ "$OWNER" != "root" ] || [ "$PERMS" -gt 640 ]; then
        echo "   [!] 취약: $FTPUSERS_FILE 파일의 소유자 또는 권한이 부적절합니다. (소유자: $OWNER, 권한: $PERMS)" | tee -a $RESULT_FILE
        U63_VULN="취약"
    else
        echo "   [V] 양호: $FTPUSERS_FILE 파일의 소유자와 권한이 올바르게 설정되어 있습니다." | tee -a $RESULT_FILE
    fi
else
    echo "   [i] 정보: $FTPUSERS_FILE 파일을 찾을 수 없습니다." | tee -a $RESULT_FILE
fi
echo " 점검 결과: $U63_VULN" | tee -a $RESULT_FILE
if [ "$U63_VULN" = "취약" ]; then
    VULN_LIST+=("[U-63] Ftpusers 파일 소유자 및 권한 설정")
fi

echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
# --------------------------------------------------------------------------------------------------
# U-64 Ftpusers 파일 설정 (root 계정 접속 차단)
# --------------------------------------------------------------------------------------------------
echo "[U-64] Ftpusers 파일 설정 (root 계정 접속 차단)" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : FTP 서비스가 비활성화 되어 있거나, 활성화 시 root 계정 접속을 차단한 경우" | tee -a $RESULT_FILE
echo " [취약] : FTP 서비스가 활성화 되어 있고, root 계정 접속을 허용한 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo $line | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

U64_VULN="양호"
FTPUSERS_FILE="/etc/ftpusers"

if [ -f "$FTPUSERS_FILE" ]; then
    if grep -q "^root" "$FTPUSERS_FILE"; then
        echo "   [V] 양호: $FTPUSERS_FILE 파일에 root 계정이 등록되어 있습니다." | tee -a $RESULT_FILE
    else
        echo "   [!] 취약: $FTPUSERS_FILE 파일에 root 계정이 등록되어 있지 않습니다." | tee -a $RESULT_FILE
        U64_VULN="취약"
    fi
else
    echo "   [!] 취약: $FTPUSERS_FILE 파일을 찾을 수 없습니다. root 계정 차단 여부를 확인할 수 없습니다." | tee -a $RESULT_FILE
    U64_VULN="취약"
fi
echo " 점검 결과: $U64_VULN" | tee -a $RESULT_FILE
if [ "$U64_VULN" = "취약" ]; then
    VULN_LIST+=("[U-64] Ftpusers 파일 설정 (root 계정 접속 차단)")
fi

echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
# --------------------------------------------------------------------------------------------------
# U-65 at/crontab 파일 소유자 및 권한 설정
# --------------------------------------------------------------------------------------------------
echo "[U-65] at/crontab 파일 소유자 및 권한 설정" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : at 명령어 일반사용자 금지 및 at 관련 파일 640 이하인 경우" | tee -a $RESULT_FILE
echo " [취약] : at 명령어 일반사용자 사용가능하거나, at 관련 파일 640 이상인 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo $line | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

U65_VULN="양호"
AT_CRON_EXECS=("crontab" "at")
AT_CRON_FILES=("/etc/crontab" "/etc/cron.d" "/etc/cron.daily" "/etc/cron.weekly" "/etc/cron.monthly" "/etc/cron.hourly" "/etc/at.allow" "/etc/at.deny" "/etc/cron.allow" "/etc/cron.deny")

for exec_file in "${AT_CRON_EXECS[@]}"; do
    EXEC_PATH=$(which "$exec_file" 2>/dev/null)
    if [ -n "$EXEC_PATH" ]; then
        OWNER=$(stat -c '%U' "$EXEC_PATH")
        PERMS=$(stat -c '%a' "$EXEC_PATH")
        if [ "$OWNER" != "root" ] || [ "$PERMS" -gt 750 ]; then
            echo "   [!] 취약: $EXEC_PATH 명령어의 소유자 또는 권한이 부적절합니다. (소유자: $OWNER, 권한: $PERMS)" | tee -a $RESULT_FILE
            U65_VULN="취약"
        else
            echo "   [V] 양호: $EXEC_PATH 명령어의 소유자와 권한이 올바르게 설정되었습니다." | tee -a $RESULT_FILE
        fi
    else
        echo "   [i] 정보: $exec_file 명령어를 찾을 수 없습니다." | tee -a $RESULT_FILE
    fi
done

for file in "${AT_CRON_FILES[@]}"; do
    if [ -f "$file" ]; then
        OWNER=$(stat -c '%U' "$file")
        PERMS=$(stat -c '%a' "$file")
        if [ "$OWNER" != "root" ] || [ "$PERMS" -gt 640 ]; then
            echo "   [!] 취약: $file 파일의 소유자 또는 권한이 부적절합니다. (소유자: $OWNER, 권한: $PERMS)" | tee -a $RESULT_FILE
            U65_VULN="취약"
        else
            echo "   [V] 양호: $file 파일의 소유자와 권한이 올바르게 설정되었습니다." | tee -a $RESULT_FILE
        fi
    else
        echo "   [i] 정보: $file 파일을 찾을 수 없습니다." | tee -a $RESULT_FILE
    fi
done
echo " 점검 결과: $U65_VULN" | tee -a $RESULT_FILE
if [ "$U65_VULN" = "취약" ]; then
    VULN_LIST+=("[U-65] at/crontab 파일 소유자 및 권한 설정")
fi

echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
# --------------------------------------------------------------------------------------------------
# U-66 SNMP 서비스 구동 점검
# --------------------------------------------------------------------------------------------------
echo "[U-66] SNMP 서비스 구동 점검" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : SNMP 서비스를 사용하지 않는 경우" | tee -a $RESULT_FILE
echo " [취약] : SNMP 서비스를 사용하는 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo $line | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

U66_VULN="양호"
SNMP_SERVICE="snmpd"

if systemctl is-active --quiet "$SNMP_SERVICE" 2>/dev/null; then
    echo "   [!] 취약: $SNMP_SERVICE 서비스가 현재 구동 중입니다." | tee -a $RESULT_FILE
    U66_VULN="취약"
else
    echo "   [V] 양호: $SNMP_SERVICE 서비스가 현재 중지되어 있습니다." | tee -a $RESULT_FILE
fi

if systemctl is-enabled --quiet "$SNMP_SERVICE" 2>/dev/null; then
    echo "   [!] 취약: $SNMP_SERVICE 서비스가 부팅 시 자동 시작되도록 설정되어 있습니다." | tee -a $RESULT_FILE
    U66_VULN="취약"
else
    echo "   [V] 양호: $SNMP_SERVICE 서비스가 부팅 시 자동 시작되지 않습니다." | tee -a $RESULT_FILE
fi
echo " 점검 결과: $U66_VULN" | tee -a $RESULT_FILE
if [ "$U66_VULN" = "취약" ]; then
    VULN_LIST+=("[U-66] SNMP 서비스 구동 점검")
fi

echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
# --------------------------------------------------------------------------------------------------
# U-67 SNMP 서비스 커뮤니티스트링의 복잡성 설정
# --------------------------------------------------------------------------------------------------
echo "[U-67] SNMP 서비스 커뮤니티스트링의 복잡성 설정" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : SNMP Community 이름이 public, private 이 아닌 경우" | tee -a $RESULT_FILE
echo " [취약] : SNMP Community 이름이 public, private 인 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo $line | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

U67_VULN="양호"
SNMP_CONF_FILE="/etc/snmp/snmpd.conf"

if [ -f "$SNMP_CONF_FILE" ]; then
    if grep -vE '^\s*#' "$SNMP_CONF_FILE" | grep -qE '\b(public|private)\b'; then
        echo "   [!] 취약: $SNMP_CONF_FILE 파일에서 'public' 또는 'private' 커뮤니티명이 사용되고 있습니다." | tee -a $RESULT_FILE
        U67_VULN="취약"
    else
        echo "   [V] 양호: $SNMP_CONF_FILE 파일에서 추측하기 쉬운 커뮤니티명이 발견되지 않았습니다." | tee -a $RESULT_FILE
    fi
else
    echo "   [i] 정보: $SNMP_CONF_FILE 파일을 찾을 수 없습니다." | tee -a $RESULT_FILE
fi
echo " 점검 결과: $U67_VULN" | tee -a $RESULT_FILE
if [ "$U67_VULN" = "취약" ]; then
    VULN_LIST+=("[U-67] SNMP 서비스 커뮤니티스트링의 복잡성 설정")
fi

echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
# --------------------------------------------------------------------------------------------------
# U-68 로그온 시 경고 메세지 제공
# --------------------------------------------------------------------------------------------------
echo "[U-68] 로그온 시 경고 메세지 제공" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : 서버 및 Telnet, FTP, SMTP, DNS 서비스에 로그온 메시지가 설정되어 있는 경우" | tee -a $RESULT_FILE
echo " [취약] : 서버 및 Telnet, FTP, SMTP, DNS 서비스에 로그온 메시지가 설정되어 있지 않은 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo $line | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

U68_VULN="양호"
WARNING_FILES=("/etc/motd" "/etc/issue.net")

for file in "${WARNING_FILES[@]}"; do
    if [ ! -s "$file" ]; then
        echo "   [!] 취약: $file 파일이 비어 있거나 존재하지 않아 경고 메시지 설정이 미흡합니다." | tee -a $RESULT_FILE
        U68_VULN="취약"
    else
        echo "   [V] 양호: $file 파일에 경고 메시지가 존재합니다." | tee -a $RESULT_FILE
    fi
done
echo " 점검 결과: $U68_VULN" | tee -a $RESULT_FILE
if [ "$U68_VULN" = "취약" ]; then
    VULN_LIST+=("[U-68] 로그온 시 경고 메세지 제공")
fi

echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
# --------------------------------------------------------------------------------------------------
# U-69 at/cron 접근 통제 설정
# --------------------------------------------------------------------------------------------------
echo "[U-69] at/cron 접근 통제 설정" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : NFS 접근제어 설정파일의 소유자가 root 이고, 권한이 644 이하인 경우" | tee -a $RESULT_FILE
echo " [취약] : NFS 접근제어 설정파일의 소유자가 root 가 아니거나, 권한이 644 이하인 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo $line | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

U69_VULN="양호"
AT_ALLOW_FILE="/etc/at.allow"
AT_DENY_FILE="/etc/at.deny"
CRON_ALLOW_FILE="/etc/cron.allow"
CRON_DENY_FILE="/etc/cron.deny"

if [ ! -f "$AT_ALLOW_FILE" ] && [ ! -f "$AT_DENY_FILE" ]; then
    echo "   [!] 취약: $AT_ALLOW_FILE 및 $AT_DENY_FILE 파일이 모두 존재하지 않습니다." | tee -a $RESULT_FILE
    U69_VULN="취약"
else
    echo "   [V] 양호: at 서비스 접근 제어 파일이 존재합니다." | tee -a $RESULT_FILE
fi

if [ ! -f "$CRON_ALLOW_FILE" ] && [ ! -f "$CRON_DENY_FILE" ]; then
    echo "   [!] 취약: $CRON_ALLOW_FILE 및 $CRON_DENY_FILE 파일이 모두 존재하지 않습니다." | tee -a $RESULT_FILE
    U69_VULN="취약"
else
    echo "   [V] 양호: cron 서비스 접근 제어 파일이 존재합니다." | tee -a $RESULT_FILE
fi
echo " 점검 결과: $U69_VULN" | tee -a $RESULT_FILE
if [ "$U69_VULN" = "취약" ]; then
    VULN_LIST+=("[U-69] at/cron 접근 통제 설정")
fi

echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
# --------------------------------------------------------------------------------------------------
# U-70 rlogind, telnetd, ftpd 서비스 비활성화
# --------------------------------------------------------------------------------------------------
echo "[U-70] rlogind, telnetd, ftpd 서비스 비활성화" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : SMTP 서비스 미사용 또는, noexpn, novrfy 옵션이 설정되어 있는 경우" | tee -a $RESULT_FILE
echo " [취약] : SMTP 서비스를 사용하고, noexpn, novrfy 옵션이 설정되어 있지 않는 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo $line | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

U70_VULN="양호"
LEGACY_SERVICES=("rlogind" "telnetd" "ftpd")

for service in "${LEGACY_SERVICES[@]}"; do
    if systemctl is-enabled --quiet "$service" 2>/dev/null || systemctl is-active --quiet "$service" 2>/dev/null; then
        echo "   [!] 취약: $service 서비스가 활성화되어 있습니다." | tee -a $RESULT_FILE
        U70_VULN="취약"
    else
        echo "   [V] 양호: $service 서비스가 비활성화되어 있습니다." | tee -a $RESULT_FILE
    fi
done
echo " 점검 결과: $U70_VULN" | tee -a $RESULT_FILE
if [ "$U70_VULN" = "취약" ]; then
    VULN_LIST+=("[U-70] rlogind, telnetd, ftpd 서비스 비활성화")
fi

echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
# --------------------------------------------------------------------------------------------------
# U-71 Finger 서비스 비활성화
# --------------------------------------------------------------------------------------------------
echo "[U-71] Finger 서비스 비활성화" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : ServerTokens Prod, ServerSignature Off로 설정되어있는 경우" | tee -a $RESULT_FILE
echo " [취약] : ServerTokens Prod, ServerSignature Off로 설정되어있지 않은 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo $line | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

U71_VULN="양호"
FINGER_SERVICE="finger"

if systemctl is-enabled --quiet "$FINGER_SERVICE" 2>/dev/null || systemctl is-active --quiet "$FINGER_SERVICE" 2>/dev/null; then
    echo "   [!] 취약: $FINGER_SERVICE 서비스가 활성화되어 있습니다." | tee -a $RESULT_FILE
    U71_VULN="취약"
else
    echo "   [V] 양호: $FINGER_SERVICE 서비스가 비활성화되어 있습니다." | tee -a $RESULT_FILE
fi
echo " 점검 결과: $U71_VULN" | tee -a $RESULT_FILE
if [ "$U71_VULN" = "취약" ]; then
    VULN_LIST+=("[U-71] Finger 서비스 비활성화")
fi

echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
# --------------------------------------------------------------------------------------------------
# U-72 정책에 따른 시스템 로깅 설정
# --------------------------------------------------------------------------------------------------
echo "[U-72] 정책에 따른 시스템 로깅 설정" | tee -a $RESULT_FILE
echo " 기준:" | tee -a $RESULT_FILE
echo " [양호] : 로그 기록 정책이 정책에 따라 설정되어 수립되어 있으며 보안정책에 따라 로그를 남기고 있을 경우" | tee -a $RESULT_FILE
echo " [취약] : 로그 기록 정책 미수립 또는, 정책에 따라 설정되어 있지 않거나 보안정책에 따라 로그를 남기고 있지 않을 경우" | tee -a $RESULT_FILE
echo "" | tee -a $RESULT_FILE
echo $line | tee -a $RESULT_FILE
echo " 점검 결과:" | tee -a $RESULT_FILE

U72_VULN="양호"
SYSLOG_CONF="/etc/syslog.conf"
RSYSLOG_CONF="/etc/rsyslog.conf"
CONF_FILE=""

if [ -f "$RSYSLOG_CONF" ]; then
    CONF_FILE="$RSYSLOG_CONF"
elif [ -f "$SYSLOG_CONF" ]; then
    CONF_FILE="$SYSLOG_CONF"
else
    echo "   [!] 취약: 로그 설정 파일이 존재하지 않습니다." | tee -a $RESULT_FILE
    U72_VULN="취약"
fi

if [ -n "$CONF_FILE" ]; then
    if ! grep -qE "^\*\.info;mail\.none;authpriv\.none;cron\.none\s+\/var\/log\/messages" "$CONF_FILE" || \
       ! grep -qE "^authpriv\.\*\s+\/var\/log\/secure" "$CONF_FILE" || \
       ! grep -qE "^mail\.\*\s+\/var\/log\/maillog" "$CONF_FILE"; then
        echo "   [!] 취약: 필수 로깅 설정이 누락되었거나 잘못되었습니다." | tee -a $RESULT_FILE
        U72_VULN="취약"
    else
        echo "   [V] 양호: 필수 로깅 설정이 올바르게 구성되어 있습니다." | tee -a $RESULT_FILE
    fi
fi
echo " 점검 결과: $U72_VULN" | tee -a $RESULT_FILE
if [ "$U72_VULN" = "취약" ]; then
    VULN_LIST+=("[U-72] 정책에 따른 시스템 로깅 설정")
fi

echo -e "${COLOR_WARN} $line ${COLOR_RESET}"
#=====================================================================================================



# ANSI 색상 정의
COLOR_LINE="\033[38;5;117m"   # 세련된 하늘색
COLOR_TITLE="\033[1;38;5;117m"  # 굵은 세련된 하늘색
COLOR_OK="\033[32m"          # 초록색
COLOR_WARN="\033[38;5;214m"  # 주황색
COLOR_RESET="\033[0m"        # 색상 초기화
COLOR_BG_RED="\033[41;1;37m"  # 빨간색 배경 + 굵은 흰색 글씨
COLOR_RESET="\033[0m"

#------------------------------------------------
# 최종 점검 요약
RESULT_FILE="./result_cmd.txt"
# 최종 점검 요약
{
    echo -e "${COLOR_WARN}$line${COLOR_RESET}" 
    echo -e "${COLOR_BG_RED}최종 점검 요약${COLOR_RESET}"
    if [ ${#VULN_LIST[@]} -eq 0 ]; then
        echo -e "${COLOR_BG_RED}  모든 점검 항목이 양호합니다. ${COLOR_RESET}" 
    else
        echo -e "${COLOR_BG_RED}  취약 항목 및 점검 불가 항목: ${COLOR_RESET}" 
        for item in "${VULN_LIST[@]}"; do
            echo " - $item"
        done
    fi
    echo "" 
    echo -e "${COLOR_WARN}$line${COLOR_RESET}"

} | tee "$RESULT_FILE"
