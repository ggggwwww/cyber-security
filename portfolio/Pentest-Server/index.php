<?php
session_start();

// 게시물 상세보기 AJAX 요청 처리
if (isset($_POST['view_notice_id'])) {
    $id = intval($_POST['view_notice_id']);
    $conn = new mysqli("localhost", "dbmaster", "1234", "pentestDB");
    if ($conn->connect_error) { die("DB 연결 실패: " . $conn->connect_error); }
    $sql = "SELECT title, content, created_at FROM boards WHERE id = $id";
    $result = $conn->query($sql);
    if ($row = $result->fetch_assoc()) {
        echo "<h3>".htmlspecialchars($row['title'])."</h3>";
        echo "<hr>";
        echo "<p>".nl2br(htmlspecialchars($row['content']))."</p>";
        echo "<span style='color:#aaa;font-size:0.95em;'>작성일: ".htmlspecialchars($row['created_at'])."</span>";
    } else {
        echo "<div style='color:red;'>해당 게시물을 찾을 수 없습니다.</div>";
    }
    $conn->close();
    exit;
}
?>
<html>
<head>
    <title>SecuriCare Main</title>
    <link rel="stylesheet" type="text/css" href="css/index.css"/>
    <script>
        function showNotice(id) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "index.php", true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.onreadystatechange = function(){
                if(xhr.readyState === 4 && xhr.status === 200){
                    document.getElementById('notice-content').innerHTML = xhr.responseText;
                    document.getElementById('notice-modal').style.display = 'block';
                }
            };
            xhr.send("view_notice_id=" + encodeURIComponent(id));
        }
        function closeNotice() {
            document.getElementById('notice-modal').style.display = 'none';
        }
    </script>
</head>
<body>
<!-- 헤더/로고 영역 (최좌상단 고정) -->
<div class="header-bar">
    <div class="logo-area">
        <div class="logo-img"></div>
        <span class="logo-title">SecuriCare</span>
    </div>
</div>

<!-- 뉴스+게시판(최좌상단, 로고 바로 아래) -->
<div class="panel-left">
    <div id="newsDiv">
        <div class="news-title">SecuriCare 뉴스·공지사항</div>
        <marquee>SecuriCare에 오신 것을 환영합니다! 최고의 의료 서비스를 제공합니다.</marquee>
        <fieldset class="notice-fieldset">
            <legend class="notice-legend">최신 공지(↓아래 클릭해서 확인)</legend>
            <div style="margin:18px 0;">
                <ul id="notice-list">
                    <?php
                    $conn = new mysqli("localhost", "dbmaster", "1234", "pentestDB");
                    if ($conn->connect_error) { die("DB 연결 실패: " . $conn->connect_error); }
                    $sql = "SELECT id, title FROM boards WHERE board_type = 'notice' ORDER BY created_at DESC LIMIT 10";
                    $result = $conn->query($sql);
                    while ($row = $result->fetch_assoc()) {
                        echo "<li onclick=\"showNotice(".$row['id'].")\">".htmlspecialchars($row['title'])."</li>";
                    }
                    $conn->close();
                    ?>
                </ul>
            </div>
        </fieldset>
    </div>
    <div class="board-section">
        <fieldset>
            <legend>게시판</legend>
            <div id="boards">
                <ul>
                    <li><a href="board/notice_view.php">공지 게시판</a></li>
                    <li><a href="board/feedback_view.php">건의사항 게시판</a></li>
                    <li><a href="board/errorReport_view.php">오류 보고 게시판</a></li>
                </ul>
            </div>
        </fieldset>
    </div>
</div>
<!-- 로그인+관리폼+프로필+info (최우상단) -->
<div class="panel-right auth-panel">
    <?php if(!isset($_SESSION['user_id'])): ?>
    <div id="loginDiv" class="loginDiv">
        <form method="post" action="auth/login.php">
            <div class="form-row">
                <label for="login_id">Id</label>
                <input type="text" id="login_id" name="id" placeholder="아이디를 입력하세요" />
            </div>
            <div class="form-row">
                <label for="login_pw">Password</label>
                <input type="password" id="login_pw" name="pw" placeholder="비밀번호를 입력하세요" />
            </div>
            <button type="submit">로그인</button>
            <button><a href="auth/register_view.php">회원가입</a></button>
        </form>
    </div>
    <?php else: ?>
    <div id="profile-card" class="profile-card">
        <img class="profile-img" src="profile/images/default.png" alt="Profile Image" width="100" height="100"/><br/>
        <?php echo "<h3>".$_SESSION['username']."님</h3>"; ?>
        <button><a href="profile/profile.php">프로필 관리</a></button>
        <button><a href="auth/logout.php">로그아웃</a></button>
    </div>
    <?php endif; ?>
    <?php
        if(isset($_SESSION['role'])) {
            echo '<hr>';
            echo '<fieldset class="notice-fieldset">';
            echo '<legend class="notice-legend">관리/기능 메뉴</legend>';
            if($_SESSION['role']=='doctor'){
                echo '<div id="doctorDiv"><ul>';
                echo '<li><button><a href="doctor/patient_records.php">진료 관리</a></button></li>';
                echo '<li><button><a href="doctor/patient_info.php">환자 정보</a></button></li>';
                echo '</ul></div>';
            }
            else if($_SESSION['role']=='admin'){
                echo '<div id="adminDiv"><ul>';
                echo '<li><button><a href="admin/admin.php">관리자 페이지</a></button></li>';
                echo '</ul></div>';
            }
            else if($_SESSION['role']=='patient'){
                echo '<div id="patientDiv"><ul>';
                echo '<li><button><a href="patient/my_reservation.php">나의 진료 예약</a></button></li>';
                echo '<li><button><a href="patient/my_records.php">나의 진료 기록</a></button></li>';
                echo '</ul></div>';
            }
            echo '</fieldset>';
        }
    ?>
    <div id="infoDiv">
        <?php
            if(isset($_SESSION['user_id'])) {
                echo '<span>안녕하세요 '. htmlspecialchars($_SESSION['username']) .'님</span>';
            }
        ?> 
    </div>
</div>
<!-- 게시물 상세보기 모달 -->
<div id="notice-modal">
    <button onclick="closeNotice()">X</button>
    <div id="notice-content"></div>
</div>
</body>
</html>
<?php
if(isset($_SESSION['user_id'])){
    echo "<script>document.getElementById('loginDiv').style.display = 'none';</script>";
}
?>
