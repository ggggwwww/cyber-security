<?php
    session_start();
    if (!isset($_SESSION['user_id'])) {
        header('Location: /login.php');
        exit();
    }
?>

<html>
    <head>
        <link rel="stylesheet" type="text/css" href="../css/profile.css">
        <title>프로필 페이지</title>
        <script>
        function show_update_form() {
            var formDiv = document.getElementById('update_info_form');
            if (formDiv.style.display === 'none' || formDiv.style.display === '') {
                formDiv.style.display = 'block';
            } else {
                formDiv.style.display = 'none';
            }
        }
        </script>
    </head>

    <body>
        <header>
            <h1>SecuriCare</h1>
        </header>
        <div class="main-wrapper">
            <?php

                $servername = "localhost";  // DB 서버 주소
                $username = "dbmaster";     // DB 사용자명
                $password = "1234";         // DB 비밀번호
                $dbname = "pentestDB";      // DB 이름
                
                
                $conn = new mysqli($servername, $username, $password, $dbname);
                if ($conn->connect_error) {
                    die("DB 연결 실패: " . $conn->connect_error);
                }
                $sql = "SELECT * FROM users WHERE id = '" . $conn->real_escape_string($_SESSION['user_id']) . "'";
                $result = $conn->query($sql);
                $row = $result->fetch_assoc();
                $birth_year = date("Y", strtotime($row["birth"]));
                $age = date("Y") - intval($birth_year);

                echo '<div id="profile_info">';
                echo '<fieldset>';
                echo '<legend>기본 정보</legend>';
                echo '<img src="'.htmlspecialchars($row["profile_image"]).'" alt="Profile Image" width="100" height="100"/><br/>';
                echo '<h3>이름</h3><br/>';
                echo '<span>'.$_SESSION['username'].'</span><br/>';
                echo '<h3>역할</h3><br/>';
                echo '<span>'.$_SESSION['role'].'</span><br/>';
                echo "<h3>성별</h3>";
                echo "<span>".htmlspecialchars($row["sex"])."</span>";
                echo "<h3>생년월일</h3>";
                echo "<span>".htmlspecialchars($row["birth"])." (".$age."세)</span>";
                echo "<h3>전화번호</h3>";
                echo "<span>".htmlspecialchars($row["phone"])."</span>";
                echo "<h3>주소</h3>";
                echo "<span>".htmlspecialchars($row["address"])."</span>";
                echo '</fieldset>';
                echo '</div>';
                echo '<hr/>';
                if($_SESSION['role'] == 'patient'){
                    $sql = 'SELECT chronic_disease, allergy FROM patient_info WHERE username = "' . $conn->real_escape_string($_SESSION['username']) . '"';
                    $result = $conn->query($sql);
                    $row = $result->fetch_assoc();
                    
                    echo '<div id="patient_info"><h3>환자 정보</h3>';
                    echo '<span>만성 질환: '.htmlspecialchars($row['chronic_disease']).'</span><br/>';
                    echo '<span>알레르기: '.htmlspecialchars($row['allergy']).'</span><br/></div>';
                    echo '<button onclick="show_update_form()">정보 변경탭 열기</button>';
                    echo '<div id="update_info_form" style="display:none;">';
                    echo '<form method="post" action="/patient/update_patient_info.php">
                                <fieldset>
                                    <legend>환자 정보 업데이트</legend>
                                    <label for="chronic_disease">만성 질환:</label>
                                    <input type="text" id="chronic_disease" name="chronic_disease" placeholder="만성 질환을 입력하세요"/><br/>
                                    <label for="allergy">알레르기:</label>
                                    <input type="text" id="allergy" name="allergy" placeholder="알레르기를 입력하세요"/><br/>
                                    <button type="submit">정보 업데이트</button>
                                </fieldset>
                            </form>
                            </div>
                        </div>';
                    
                }
            ?>
        </div>
    </body>
</html> 