<?php
    session_start();
    if (!isset($_SESSION['user_id'])) {
        header('Location: /login.php');
        exit();
    }
?>

<html>
    <head>
        <title>프로필 페이지</title>
        <script>
        function show_update_form() {
            var formDiv = document.getElementById('update_info_form');
            if (formDiv.style.display === 'none' || formDiv.style.display === '') {
                formDiv.style.display = 'block';
            } else {
                formDiv.style.display = 'none';
            }
        }
        </script>
    </head>

    <body>
        <h1>프로필 정보</h1>
        <?php

            $servername = "localhost";  // DB 서버 주소
            $username = "dbmaster";     // DB 사용자명
            $password = "1234";         // DB 비밀번호
            $dbname = "pentestDB";      // DB 이름
            
            
            $conn = new mysqli($servername, $username, $password, $dbname);
            if ($conn->connect_error) {
                die("DB 연결 실패: " . $conn->connect_error);
            }
            $sql = "SELECT profile_image FROM users WHERE id = '" . $conn->real_escape_string($_SESSION['user_id']) . "'";
            $result = $conn->query($sql);
            $row = $result->fetch_assoc();
            echo '<img src="'.htmlspecialchars($row["profile_image"]).'" alt="Profile Image" width="100" height="100"/><br/>';
            echo '이름: '.$_SESSION['username'].'<br/>';
            if($_SESSION['role'] == 'patient'){
                $sql = 'SELECT chronic_disease, allergy FROM patient_info WHERE username = "' . $conn->real_escape_string($_SESSION['username']) . '"';
                $result = $conn->query($sql);
                $row = $result->fetch_assoc();
                
                echo '<div id="patient_info"><h3>환자 정보</h3>';
                echo '<span>만성 질환: '.htmlspecialchars($row['chronic_disease']).'</span><br/>';
                echo '<span>알레르기: '.htmlspecialchars($row['allergy']).'</span><br/></div>';
                echo '<button onclick="show_update_form()">정보 변경탭 열기</button>';
                echo '<div id="update_info_form" style="display:none;">';
                echo '<form method="post" action="/patient/update_patient_info.php">
                            <fieldset>
                                <legend>환자 정보 업데이트</legend>
                                <label for="chronic_disease">만성 질환:</label>
                                <input type="text" id="chronic_disease" name="chronic_disease" placeholder="만성 질환을 입력하세요"/><br/>
                                <label for="allergy">알레르기:</label>
                                <input type="text" id="allergy" name="allergy" placeholder="알레르기를 입력하세요"/><br/>
                                <button type="submit">정보 업데이트</button>
                            </fieldset>
                        </form>
                        </div>
                    </div>';
                
            }
        ?>
    </body>
</html> 