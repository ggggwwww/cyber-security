<?php
    session_start();
?>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="../css/patient.css"/>
        <title>나의 진료 예약</title>
    </head>

    <body>
        <div class="header-bar"><h1>SecuriCare</h1></div>
        <div class="main-content">
            <h2>나의 진료 예약</h2>
            <?php
                $servername = "localhost";  // DB 서버 주소
                $username = "dbmaster";     // DB 사용자명
                $password = "1234";         // DB 비밀번호
                $dbname = "pentestDB";      // DB 이름

                $conn = new mysqli($servername, $username, $password, $dbname);
                if ($conn->connect_error) {
                    die("DB 연결 실패: " . $conn->connect_error);
                } 

                $sql = "SELECT * FROM reservations WHERE patient_username = '" . $_SESSION['username'] . "'";
                $result = $conn->query($sql);

                if (!$result) {
                    echo "SQL 오류: " . $conn->error;
                }
                if($result->num_rows == 0){
                    echo "<h2>예약된 진료가 없습니다.</h2>";
                }
                else{

                    // 진료 통계 정보 출력
                    echo "<div id='reservation-stats'>";
                    echo "<h2>총 진료 횟수: " . $result->num_rows . "회</h2>";
                    $recent_sql = "SELECT MAX(reservation_date) AS recent_date FROM reservations WHERE patient_username = '" . $_SESSION['username'] . "'";
                    $date_result = $conn->query($recent_sql);
                    $recent_date = $date_result->fetch_assoc()['recent_date'];
                    echo "<h2>최근 진료일: " . htmlspecialchars($recent_date) . "</h2>";
                    echo "</div>";

                    // 예약 내역 테이블 출력
                    echo "<table border='1'><tr><th>의사 이름</th><th>예약 날짜</th><th>예약 시간</th><th>몸 상태</th><th>접수 변경</th></tr>";
                    while($row = $result->fetch_assoc()) {
                        echo "<tr>";
                        echo "<td>".htmlspecialchars($row["doctor_username"])."</td>";
                        echo "<td>".htmlspecialchars($row["reservation_date"])."</td>";
                        echo "<td>".htmlspecialchars($row["reservation_time"])."</td>";
                        echo "<td>".htmlspecialchars($row["_status"])."</td>";
                        echo "<td>
                            <form style='display:inline;' method='POST' action='cancel_reservation.php'>
                                <input type='hidden' name='reservation_id' value='".htmlspecialchars($row["id"])."'>
                                <button type='submit'>취소</button>
                            </form>
                        </td>";
                        echo "</tr>";
                    }
                    echo "</table>";
                }

                $conn->close();
            ?>
            <button><a href="reservation.php">진료 예약 하기</a></button>
        </div>
    </body>
</html>