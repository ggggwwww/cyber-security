<?php
session_start();
if (!isset($_SESSION['user_id']) || ($_SESSION['role'] != 'patient' && $_SESSION['role'] != 'admin')) {
    header('Location: /login.php');
    exit();
}

$servername = "localhost";
$username = "dbmaster";
$password = "1234";
$dbname = "pentestDB";

$conn = new mysqli($servername, $username, $password, $dbname);
if ($conn->connect_error) {
    die("DB 연결 실패: " . $conn->connect_error);
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $chronic_disease = $conn->real_escape_string($_POST['chronic_disease']);
    $allergy = $conn->real_escape_string($_POST['allergy']);
    $username = $conn->real_escape_string($_SESSION['username']); // 일관되게 escape

    // 기존 정보 존재 여부 체크
    $check_sql = "SELECT chronic_disease, allergy FROM patient_info WHERE username='$username'";
    $check_result = $conn->query($check_sql);
    $check_row = $check_result ? $check_result->fetch_assoc() : false;

    if (!$check_row) {
        // 정보 없음 → INSERT
        $insert_sql = "INSERT INTO patient_info (username, chronic_disease, allergy) 
                       VALUES ('$username', '$chronic_disease', '$allergy')";
        if ($conn->query($insert_sql) !== TRUE) {
            $_SESSION['update_message'] = "오류 발생: " . $conn->error;
        }
    } else {
        // 정보 있음 → UPDATE
        $edit_sql = "UPDATE patient_info SET chronic_disease='$chronic_disease', allergy='$allergy' 
                     WHERE username='$username'";
        if ($conn->query($edit_sql) !== TRUE) {
            $_SESSION['update_message'] = "오류 발생: " . $conn->error;
        }
    }
    $conn->close();

    header('Location: /profile/profile.php');
    exit();
}
?>

<?php
    session_start();
    if (isset($_SESSION['update_message'])) {
        echo "<script>alert('" . addslashes($_SESSION['update_message']) . "');</script>";
        unset($_SESSION['update_message']);
    }
?>
