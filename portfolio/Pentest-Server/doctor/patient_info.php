<?php
session_start();
?>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="../css/doctor.css"/>
    <title>환자 정보 페이지</title>

    <script>
        function selectPatient(username) {
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = ''; // 자기 자신

            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_patient';
            input.value = username;
            form.appendChild(input);

            document.body.appendChild(form);
            form.submit();
            // ★ display 변경 불필요, 새로고침 직전이므로 아래 코드는 삭제
            // var selInfo = document.getElementById('selected-patient-info');
            // selInfo.style.display = 'block';
        }
        function goToPrescription(patientUsername, isNew) {
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = 'submit_prescription.php';

            var input1 = document.createElement('input');
            input1.type = 'hidden';
            input1.name = 'patient_username';
            input1.value = patientUsername;
            form.appendChild(input1);

            var input2 = document.createElement('input');
            input2.type = 'hidden';
            input2.name = 'isNew';
            input2.value = isNew;
            form.appendChild(input2);

            document.body.appendChild(form);
            form.submit();
        }
    </script>
</head>
<body>
    <div class="header-bar"><h1>SecuriCare</h1></div>
    <div class="main-content">

        <?php
        $servername = "localhost";
        $username = "dbmaster";
        $password = "1234";
        $dbname = "pentestDB";
        $conn = new mysqli($servername, $username, $password, $dbname);
        if ($conn->connect_error) {
            die("DB 연결 실패: " . $conn->connect_error);
        }

        // 환자 목록 조회
        $patients_sql = "SELECT username FROM users WHERE role='patient'";
        $patients_result = $conn->query($patients_sql);
        if ($patients_result->num_rows > 0) {
            echo "<div id='patient-list'>";
            echo "<h2>환자 목록</h2>";
            echo "<table border='1'>";
            while ($row = $patients_result->fetch_assoc()) {
                echo "<tr>
                        <td class='clickable-row' onclick=\"selectPatient('".htmlspecialchars($row["username"])."')\">"
                        .htmlspecialchars($row["username"]).
                        "</td>
                    </tr>";
            }
            echo "</table></div>";
        } else {
            echo "<h3>등록된 환자가 없습니다.</h3>";
        }

        // POST로 선택한 환자 처리
        $selected_patient = isset($_POST['selected_patient']) ? $conn->real_escape_string($_POST['selected_patient']) : '';

        // PHP에서 display 결정
        $div_style = $selected_patient ? 'display:block;' : 'display:none;';
        echo "<div id='selected-patient-info' style='$div_style'>";

        // 선택된 환자 정보 표시
        if ($selected_patient) {
            // 환자 기본 정보
            $users_sql = "SELECT username, sex, birth, phone, address FROM users WHERE username='$selected_patient'";
            $u_result = $conn->query($users_sql);
            if ($u_result->num_rows > 0) {
                $u_row = $u_result->fetch_assoc();
                $birth_year = date("Y", strtotime($u_row["birth"]));
                $patient_age = date("Y") - intval($birth_year);

                echo "<div id='patient-basic-info'>";
                echo "<h2>기본 정보</h2>";
                echo "<h3>이름</h3>";
                echo "<span>".htmlspecialchars($u_row["username"])."</span>";
                echo "<h3>성별</h3>";
                echo "<span>".htmlspecialchars($u_row["sex"])."</span>";
                echo "<h3>생년월일</h3>";
                echo "<span>".htmlspecialchars($u_row["birth"])." (".$patient_age."세)</span>";
                echo "<h3>전화번호</h3>";
                echo "<span>".htmlspecialchars($u_row["phone"])."</span>";
                echo "<h3>주소</h3>";
                echo "<span>".htmlspecialchars($u_row["address"])."</span>";
                echo "</div>";
            }
            // 만성 질환/알레르기
            $patient_info_sql = "SELECT chronic_disease, allergy FROM patient_info WHERE username='$selected_patient'";
            $pi_result = $conn->query($patient_info_sql);
            $pi_row = $pi_result->fetch_assoc();

            echo "<div id='patient-info'>";
            echo "<h2>주의 사항</h2>";
            if ($pi_result->num_rows > 0) {
                echo "<h3>만성 질환</h3>";
                echo "<span>".htmlspecialchars($pi_row["chronic_disease"])."</span>";
                echo "<h3>알레르기</h3>";
                echo "<span>".htmlspecialchars($pi_row["allergy"])."</span>";
            } else {
                echo "<span>등록된 환자 정보가 없습니다.</span>";
            }
            echo "</div>";

            // 진료기록
            $patient_record_sql = "SELECT id, username, record, prescription FROM patient_records WHERE username='$selected_patient'";
            $pr_result = $conn->query($patient_record_sql);

            echo "<div id='patient-records'>";
            echo "<h2>진료 기록</h2>";
            if ($pr_result->num_rows > 0) {
                echo "<table id='patient-records-table' border='1'><tr><th>번호</th><th>이름</th><th>진료 기록</th></tr>";
                while ($row = $pr_result->fetch_assoc()) {
                    $isNew = (empty($row["record"]) && empty($row["prescription"])) ? 1 : 0;
                    echo "<tr class='clickable-row' onclick=\"goToPrescription('"
                        . htmlspecialchars($row["username"])
                        . "', $isNew)\">";
                    echo "<td>".htmlspecialchars($row["id"])."</td>";
                    echo "<td>".htmlspecialchars($row["username"])."</td>";
                    echo "<td>".htmlspecialchars($row["record"])."</td>";
                    echo "</tr>";
                }
                echo "</table>";
            } else {
                echo "<h3>등록된 진료 내역이 없습니다.</h3>";
            }
            echo "</div>";
        }
        echo "</div>"; // selected-patient-info
        $conn->close();
        ?>
    </div>
</body>
</html>
