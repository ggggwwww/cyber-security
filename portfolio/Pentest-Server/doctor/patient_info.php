<?php
session_start();
?>
<html>
  <head>
    <title>환자 정보 페이지</title>
    <style>
      .clickable-row { cursor: pointer; }
    </style>
    <script>
    function goToPrescription(patientUsername, isNew) {
      var form = document.createElement('form');
      form.method = 'POST';
      form.action = 'submit_prescription.php';

      var input1 = document.createElement('input');
      input1.type = 'hidden';
      input1.name = 'patient_username';
      input1.value = patientUsername;
      form.appendChild(input1);

      var input2 = document.createElement('input');
      input2.type = 'hidden';
      input2.name = 'isNew';
      input2.value = isNew;
      form.appendChild(input2);

      document.body.appendChild(form);
      form.submit();
    }
    </script>
  </head>
  <body>
    <h1>환자 정보</h1>
    <?php
      $servername = "localhost";
      $username = "dbmaster";
      $password = "1234";
      $dbname = "pentestDB";

      $conn = new mysqli($servername, $username, $password, $dbname);
      if ($conn->connect_error) {
          die("DB 연결 실패: " . $conn->connect_error);
      }

      // 환자 목록 조회
      $patients_sql = "SELECT username FROM users WHERE role='patient'";
      $patients_result = $conn->query($patients_sql);
      if($patients_result->num_rows > 0){
          // 환자 목록 처리 로직 추가 가능
          echo "<div id='patient-list'>";
          echo  "<table border='1'><tr><th>환자 목록</th></tr>";
          while($row = $patients_result->fetch_assoc()){
              echo "<tr><td>".htmlspecialchars($row["username"])."</td></tr>";
          }
          echo "</table></div>";
      }else{
          echo "<h3>등록된 환자가 없습니다.</h3>";
      }
      

      // 환자 진료 기록 조회
      $patient_record_sql = "SELECT id, username, record, prescription FROM patient_records";
      $pr_result = $conn->query($patient_record_sql);
      if ($pr_result->num_rows > 0) {
          echo "<table border='1'><tr><th>ID</th><th>이름</th><th>진료 기록</th></tr>";
          while($row = $pr_result->fetch_assoc()) {
              // prescription 또는 record가 null 또는 ""이면 isNew = 1, 아니면 0
              $isNew = (empty($row["record"]) && empty($row["prescription"])) ? 1 : 0;
              echo "<tr class='clickable-row' onclick=\"goToPrescription('"
                  . htmlspecialchars($row["username"])
                  . "', $isNew)\">";
              echo "<td>".htmlspecialchars($row["id"])."</td>";
              echo "<td>".htmlspecialchars($row["username"])."</td>";
              echo "<td>".htmlspecialchars($row["record"])."</td>";
              echo "</tr>";
          }
          echo "</table>";
      } else {
          echo "<h3>등록된 환자 진료 내역이 없습니다.</h3>";
      }
      $conn->close();
    ?>
  </body>
</html>
