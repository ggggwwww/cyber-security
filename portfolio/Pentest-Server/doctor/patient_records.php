<?php
session_start();
?>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="../css/doctor.css"/>
        <title>환자 진료 현황</title>
        <script>
        function sendPrescription(patientUsername) {
            // 동적 폼 생성하여 POST 전송
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = 'prescription.php';

            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'patient_username';
            input.value = patientUsername;
            form.appendChild(input);

            document.body.appendChild(form);
            form.submit();
        }
        </script>
    </head>
    <body>
        <div class="header-bar"><h1>SecuriCare</h1></div>
        <div class="main-content">
            <h2>환자 진료 현황</h2>
            <?php
                $servername = "localhost";
                $username = "dbmaster";
                $password = "1234";
                $dbname = "pentestDB";

                $conn = new mysqli($servername, $username, $password, $dbname);
                if ($conn->connect_error) {
                    die("DB 연결 실패: " . $conn->connect_error);
                }

                if($_SESSION['role'] == 'admin') {
                     $sql = "SELECT * FROM reservations";
                }
                else if($_SESSION['role'] == 'doctor') {
                    $sql = "SELECT * FROM reservations WHERE doctor_username = '" . $_SESSION['username'] . "'";
                }
                else {
                    echo "<script>alert('권한이 없습니다.');</script>";
                    exit();
                }
                $result = $conn->query($sql);

                if (!$result) {
                    echo "SQL 오류: " . $conn->error;
                }

                echo "<table border='1'><tr><th>환자 이름</th><th>예약 날짜</th><th>예약 시간</th><th>몸 상태</th></tr>";
                while ($row = $result->fetch_assoc()) {
                    // tr 클릭 시 해당 환자이름을 prescription.php로 POST
                    echo "<tr class='clickable-row' onclick=\"sendPrescription('" . htmlspecialchars($row["patient_username"]) . "')\">";
                    echo "<td>".htmlspecialchars($row["patient_username"])."</td>";
                    echo "<td>".htmlspecialchars($row["reservation_date"])."</td>";
                    echo "<td>".htmlspecialchars($row["reservation_time"])."</td>";
                    echo "<td>".htmlspecialchars($row["_status"])."</td>";
                    echo "</tr>";
                }
                echo "</table>";

                $conn->close();
            ?>
        </div>
    </body>
</html>
