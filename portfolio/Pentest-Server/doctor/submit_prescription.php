<?php
session_start();
?>
<html>
  <head>
    <title>처방전 제출</title>
  </head>
  <body>
    <?php
      $servername = "localhost";
      $username = "dbmaster";
      $password = "1234";
      $dbname = "pentestDB";
      $conn = new mysqli($servername, $username, $password, $dbname);
      if ($conn->connect_error) {
          die("DB 연결 실패: " . $conn->connect_error);
      }
      if ($_SERVER["REQUEST_METHOD"] == "POST") {
          $isNew = isset($_POST['isNew']) ? (int)$_POST['isNew'] : null;
          $patient_username = $_POST['patient_username'];
          
          if($isNew === 1){
              // 신규 기록 (INSERT)
              // 폼에서 prescription, record 값 함께 넘겨서 처리 필요
              echo "<form method='POST' action='submit_prescription.php'>
                  <input type='hidden' name='patient_username' value='" . htmlspecialchars($patient_username) . "'>
                  <input type='hidden' name='isNew' value='1'>
                  <label>진료 내용</label><br>
                  <textarea name='record' rows='4' cols='50'></textarea><br>
                  <hr>
                  <label for='prescription'>처방전 내용:</label><br>
                  <textarea name='prescription' rows='4' cols='50'></textarea><br>
                  <input type='submit' value='제출'>
                  </form>";
              
              if (!empty($_POST['record']) && !empty($_POST['prescription'])) {
                  $record = $_POST['record'];
                  $prescription = $_POST['prescription'];
                  $sql = "INSERT INTO patient_records (username, record, prescription) VALUES ('"
                      . $patient_username . "', '" . $record . "', '" . $prescription . "')";
                  $conn->query($sql);
                  if ($conn->affected_rows > 0) {
                      echo "<script>alert('의료 기록이 성공적으로 제출되었습니다.'); window.location.href = '/doctor/patient_info.php';</script>";
                  } else {
                      echo "<script>alert('오류 발생: " . $conn->error . "');</script>";
                  }
              }
          }
          else if($isNew === 0){
              // 기존 히스토리 수정 (edit_prescription.php)
              $sql = "SELECT * FROM patient_records WHERE username = '" . $patient_username . "'";
              $result = $conn->query($sql);
              $row = $result->fetch_assoc();
              echo "<form method='POST' action='edit_prescription.php'>
                  <input type='hidden' name='record_id' value='" . htmlspecialchars($row['id']) . "'>
                  <input type='hidden' name='isNew' value='0'>
                  <label>진료 내용</label><br>
                  <textarea name='record' rows='4' cols='50'>" . htmlspecialchars($row['record']) . "</textarea><br>
                  <hr>
                  <label for='prescription'>처방전 내용:</label><br>
                  <textarea name='prescription' rows='4' cols='50'>" . htmlspecialchars($row['prescription']) . "</textarea><br>
                  <input type='submit' value='제출'>
                  </form>";
          }
          else{
              echo "<script>alert('잘못된 접근입니다.');</script>";
          }
      }
      $conn->close();
    ?>
  </body>
</html>
