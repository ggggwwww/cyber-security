<?php
    session_start();

    if($_SERVER['REQUEST_METHOD'] === 'POST'){
         $servername = "localhost";
        $username = "dbmaster";
        $password = "1234";
        $dbname = "pentestDB";

        $conn = new mysqli($servername, $username, $password, $dbname);
        if ($conn->connect_error) {
            die("DB 연결 실패: " . $conn->connect_error);
        }
        
        $title = $_POST['title'];
        $content = $_POST['content'];
        $board_type = $_POST['board_type'];
        $username = $_SESSION['username'];

        $sql = "INSERT INTO boards (username, title, content, board_type) VALUES ('" . $username . "', '" . $title . "', '" . $content . "', '" . $board_type . "')";
        
        // 파일 업로드 처리
        if($board_type == 'errReport' && isset($_FILES['file'])){ 
            $file = $_FILES['file'];
            if($file['error'] === UPLOAD_ERR_OK){
                $uploadDir = '/var/www/html/uploads/';
                if(!is_dir($uploadDir)){
                    mkdir($uploadDir, 0755, true);
                }
                $finalName = basename($file['name']);
                $filePath = $uploadDir . $finalName;
                // 파일명 중복 시, 유니크로 변경
                if(file_exists($filePath)){
                    echo "<script>alert('동일한 이름의 파일이 이미 존재합니다. 파일명이 변경되어 업로드됩니다.');</script>";
                    $finalName = time() . '_' . $finalName;
                    $filePath = $uploadDir . $finalName;
                }
                
                move_uploaded_file($file['tmp_name'], $filePath);
                // DB 기록
                $fileSql = "INSERT INTO uploads (filename) VALUES ('" . $finalName . "')";
                if($conn->query($fileSql)){
                    echo "<script>alert('파일이 성공적으로 업로드되었습니다.');</script>";
                } else {
                    echo "<script>alert('파일 업로드 기록 중 오류가 발생했습니다: " . $conn->error . "');</script>";
                }
            }
        }


        // 리다이렉트 경로 지정 함수
        function redirect_board($type, $errorMsg = '') {
            if ($errorMsg) echo "<script>alert('$errorMsg');</script>";
            $url = '';
            if ($type === 'feedback') $url = '/board/feedback_view.php';
            else if ($type === 'errReport') $url = '/board/errorReport_view.php';
            else if ($type === 'notice') $url = '/board/notice_view.php';
            if ($url) echo "<script>window.location.href = '$url';</script>";
        }
        if ($conn->query($sql) === TRUE) {
            redirect_board($board_type, '게시물이 성공적으로 제출되었습니다.');
        } else {
            redirect_board($board_type, '게시물 제출 중 오류가 발생했습니다: ' . $conn->error);
        }


        $conn->close();
    }
?>